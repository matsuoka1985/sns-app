<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNSアプリ認証システム詳細解析</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        .content {
            padding: 40px;
        }
        .section {
            margin-bottom: 40px;
        }
        .section h2 {
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        .flow-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .flow-step {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .step-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }
        .step-content {
            flex: 1;
        }
        .step-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .step-description {
            color: #666;
            font-size: 0.9em;
        }
        .component-box {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            color: #333;
        }
        .nuxt-client { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .nuxt-server { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); }
        .firebase { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
        .laravel { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .highlight {
            background: #ffd700;
            padding: 2px 4px;
            border-radius: 3px;
            color: #333;
            font-weight: bold;
        }
        .security-box {
            background: #e8f5e8;
            border: 2px solid #4caf50;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .security-title {
            color: #2e7d32;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .architecture-diagram {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        .arrow {
            font-size: 2em;
            color: #667eea;
            margin: 10px;
        }
        .tech-stack {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .tech-item {
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .performance-note {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔐 SNSアプリ認証システム詳細解析</h1>
            <p>Nuxt.js + Firebase Authentication + Laravel + JWT による統合認証フロー</p>
        </div>
        
        <div class="content">
            <!-- アーキテクチャ概要 -->
            <div class="section">
                <h2>🏗️ システム全体アーキテクチャ</h2>
                <div class="tech-stack">
                    <div class="tech-item nuxt-client">
                        <h3>Nuxt.js Client</h3>
                        <p>フロントエンド UI<br>Firebase Auth SDK</p>
                    </div>
                    <div class="tech-item nuxt-server">
                        <h3>Nuxt.js Server</h3>
                        <p>SSR & API Proxy<br>認証チェック中継</p>
                    </div>
                    <div class="tech-item firebase">
                        <h3>Firebase Auth</h3>
                        <p>ユーザー認証<br>JWT発行</p>
                    </div>
                    <div class="tech-item laravel">
                        <h3>Laravel API</h3>
                        <p>Firebase Admin SDK<br>JWT検証 & Cookie管理</p>
                    </div>
                </div>
            </div>

            <!-- ログインフロー詳細 -->
            <div class="section">
                <h2>🔑 ログイン認証フロー（詳細版）</h2>
                <div class="flow-container">
                    <div class="flow-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <div class="step-title">ユーザーがログインフォームに入力</div>
                            <div class="step-description">
                                <strong>場所:</strong> <code>frontend/components/LoginForm.vue</code><br>
                                ユーザーがメールアドレス・パスワードを入力してログインボタンをクリック
                            </div>
                        </div>
                    </div>

                    <div class="flow-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <div class="step-title">Firebase Authentication でログイン</div>
                            <div class="step-description">
                                <strong>実行場所:</strong> Nuxt.js Client (ブラウザ)<br>
                                <code>signInWithEmailAndPassword(auth, email, password)</code><br>
                                Firebase SDKがクライアントサイドで認証を実行
                            </div>
                        </div>
                    </div>

                    <div class="flow-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <div class="step-title">Firebase ID Token を取得</div>
                            <div class="step-description">
                                <strong>取得内容:</strong> JWT形式のIDトークン<br>
                                <code>const idToken = await firebaseUser.getIdToken()</code><br>
                                このトークンにはuid, email, 有効期限などの情報が含まれる
                            </div>
                        </div>
                    </div>

                    <div class="flow-step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <div class="step-title">Laravel API にログイン情報送信</div>
                            <div class="step-description">
                                <strong>エンドポイント:</strong> <code>POST /api/auth/login</code><br>
                                Firebase UID とメールアドレスをLaravelに送信（必要に応じて）
                            </div>
                        </div>
                    </div>

                    <div class="flow-step">
                        <div class="step-number">5</div>
                        <div class="step-content">
                            <div class="step-title">Laravel で Firebase Admin SDK による JWT 検証</div>
                            <div class="step-description">
                                <strong>エンドポイント:</strong> <code>POST /api/auth/verify-token</code><br>
                                <strong>処理:</strong> <code>AuthVerifyController@verifyAndSetCookie</code><br>
                                Firebase Admin SDK で ID Token の真正性・有効期限を厳密に検証
                            </div>
                        </div>
                    </div>

                    <div class="flow-step">
                        <div class="step-number">6</div>
                        <div class="step-content">
                            <div class="step-title">HTTP-Only Cookie として JWT を保存</div>
                            <div class="step-description">
                                <strong>Cookie名:</strong> <code>auth_jwt</code><br>
                                <strong>設定:</strong> HTTP-Only, SameSite=lax, 7日間有効<br>
                                JavaScript からアクセス不可で XSS 攻撃を防御
                            </div>
                        </div>
                    </div>

                    <div class="flow-step">
                        <div class="step-number">7</div>
                        <div class="step-content">
                            <div class="step-title">ホームページにリダイレクト</div>
                            <div class="step-description">
                                <code>emit('success')</code> → <code>navigateTo('/')</code><br>
                                ログイン成功を親コンポーネントに通知してページ遷移
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 認証チェックフロー -->
            <div class="section">
                <h2>🛡️ 認証チェックフロー（ページアクセス時）</h2>
                <div class="flow-container">
                    <div class="flow-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <div class="step-title">認証必須ページへのアクセス</div>
                            <div class="step-description">
                                例: <code>/posts/create</code> (投稿作成ページ)<br>
                                <code>definePageMeta({ middleware: 'require-auth' })</code>
                            </div>
                        </div>
                    </div>

                    <div class="flow-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <div class="step-title">Nuxt Middleware の実行（サーバーサイド）</div>
                            <div class="step-description">
                                <strong>ファイル:</strong> <code>frontend/middleware/requireAuth.ts</code><br>
                                <strong>重要:</strong> <span class="highlight">サーバーサイドで実行</span>してちらつきを防止<br>
                                ブラウザのCookieヘッダーを取得
                            </div>
                        </div>
                    </div>

                    <div class="flow-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <div class="step-title">Nuxt Server API で認証チェック</div>
                            <div class="step-description">
                                <strong>API:</strong> <code>frontend/server/api/auth/check.get.ts</code><br>
                                Cookie から <code>auth_jwt</code> を抽出してLaravelに転送
                            </div>
                        </div>
                    </div>

                    <div class="flow-step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <div class="step-title">Laravel で JWT 検証</div>
                            <div class="step-description">
                                <strong>エンドポイント:</strong> <code>GET /api/auth/check</code><br>
                                Firebase Admin SDK で JWT の有効性を再検証<br>
                                <span class="highlight">毎回サーバーサイドで検証</span> = 最高レベルのセキュリティ
                            </div>
                        </div>
                    </div>

                    <div class="flow-step">
                        <div class="step-number">5</div>
                        <div class="step-content">
                            <div class="step-title">認証結果に基づくページ制御</div>
                            <div class="step-description">
                                <strong>認証成功:</strong> ページ表示を許可<br>
                                <strong>認証失敗:</strong> <code>navigateTo('/login')</code> で即座にリダイレクト<br>
                                <span class="highlight">ページが一瞬たりとも表示されない</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ゲストページのアクセス制御 -->
            <div class="section">
                <h2>🚫 ゲスト専用ページのアクセス制御</h2>
                <div class="flow-container">
                    <div class="flow-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <div class="step-title">ログイン/新規登録ページへのアクセス</div>
                            <div class="step-description">
                                認証済みユーザーは <code>/login</code> や <code>/register</code> にアクセスすべきでない
                            </div>
                        </div>
                    </div>

                    <div class="flow-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <div class="step-title">ページコンポーネントで直接認証チェック</div>
                            <div class="step-description">
                                <strong>ファイル:</strong> <code>frontend/pages/login.vue</code>, <code>frontend/pages/register.vue</code><br>
                                <code>&lt;script setup&gt;</code> 内で <code>$fetch('/api/auth/check')</code>
                            </div>
                        </div>
                    </div>

                    <div class="flow-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <div class="step-title">認証済みの場合は即座にリダイレクト</div>
                            <div class="step-description">
                                <code>if (authCheck.authenticated) { await navigateTo('/') }</code><br>
                                ログイン済みユーザーはホームページに自動遷移
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- セキュリティ特徴 -->
            <div class="section">
                <h2>🔒 セキュリティ特徴</h2>
                <div class="security-box">
                    <div class="security-title">🛡️ HTTP-Only Cookie による JWT 保護</div>
                    <ul>
                        <li><strong>XSS攻撃耐性:</strong> JavaScript からクッキーにアクセス不可</li>
                        <li><strong>CSRF攻撃軽減:</strong> SameSite=lax 設定</li>
                        <li><strong>改ざん防止:</strong> Firebase Admin SDK による署名検証</li>
                    </ul>
                </div>

                <div class="security-box">
                    <div class="security-title">🔥 Firebase Admin SDK による厳密な JWT 検証</div>
                    <ul>
                        <li><strong>サーバーサイド検証:</strong> 毎回Laravelで真正性を確認</li>
                        <li><strong>有効期限チェック:</strong> 期限切れトークンは即座に無効</li>
                        <li><strong>リアルタイム無効化:</strong> Firebase側で無効化されたトークンも検出</li>
                    </ul>
                </div>

                <div class="security-box">
                    <div class="security-title">⚡ SSR による視覚的フラッシュ防止</div>
                    <ul>
                        <li><strong>サーバーサイド認証:</strong> ページレンダリング前に認証状態を確認</li>
                        <li><strong>即座のリダイレクト:</strong> 不正アクセス時はページを一瞬も表示しない</li>
                        <li><strong>Laravel級のセキュリティ:</strong> 従来のサーバーサイドアプリと同等</li>
                    </ul>
                </div>
            </div>

            <!-- パフォーマンス -->
            <div class="section">
                <h2>⚡ パフォーマンス特性</h2>
                <div class="performance-note">
                    <strong>🎯 Twitter と同じアプローチ</strong><br>
                    完全SPAの超高速体験よりもセキュリティを重視した設計。認証チェックで毎回100-200ms程度の通信が発生するが、Laravel SSRに比べて圧倒的に高速。
                </div>

                <div class="flow-container">
                    <div class="component-box nuxt-client">
                        <strong>Nuxt Client:</strong> Firebase Auth SDK、UI レンダリング
                    </div>
                    <div class="arrow">↕️</div>
                    <div class="component-box nuxt-server">
                        <strong>Nuxt Server:</strong> SSR、認証チェック中継、API プロキシ
                    </div>
                    <div class="arrow">↕️</div>
                    <div class="component-box laravel">
                        <strong>Laravel:</strong> Firebase Admin SDK、JWT検証、HTTP-Only Cookie管理
                    </div>
                    <div class="arrow">↕️</div>
                    <div class="component-box firebase">
                        <strong>Firebase:</strong> ユーザー認証、JWT発行・検証
                    </div>
                </div>
            </div>

            <!-- 主要コードスニペット -->
            <div class="section">
                <h2>💻 主要コードスニペット</h2>
                
                <h3>1. Firebase認証 + Laravel JWT検証（ログイン時）</h3>
                <div class="code-block">
// LoginForm.vue - Firebase認証
const userCredential = await signInWithEmailAndPassword(auth, email, password)
const idToken = await firebaseUser.getIdToken()

// Laravel Admin SDK でJWT検証 + HTTP-Only Cookie設定
const verifyResponse = await $fetch('/api/auth/verify-token', {
  method: 'POST',
  body: { idToken: idToken },
  credentials: 'include'
})
                </div>

                <h3>2. サーバーサイド認証チェック（ページアクセス時）</h3>
                <div class="code-block">
// requireAuth.ts - Nuxt Middleware
if (import.meta.server) {
  const event = useRequestEvent()
  const cookieHeader = event.node.req.headers.cookie || ''
  
  const authCheck = await $fetch('/api/auth/check', {
    headers: { 'Cookie': cookieHeader }
  })
  
  if (!authCheck.authenticated) {
    return navigateTo('/login')  // 即座にリダイレクト
  }
}
                </div>

                <h3>3. Laravel での JWT 検証</h3>
                <div class="code-block">
// AuthVerifyController.php
public function checkAuth(Request $request) {
    $jwt = $request->cookie('auth_jwt');
    
    // Firebase Admin SDK で検証
    $verifiedIdToken = $this->firebaseAuth->verifyIdToken($jwt);
    $firebaseUid = $verifiedIdToken->claims()->get('sub');
    
    return response()->json([
        'authenticated' => true,
        'user' => ['uid' => $firebaseUid, 'email' => $firebaseEmail]
    ]);
}
                </div>
            </div>

            <!-- まとめ -->
            <div class="section">
                <h2>📊 システム設計まとめ</h2>
                <div class="architecture-diagram">
                    <h3>🎯 設計哲学: セキュリティファースト</h3>
                    <p>完全SPAの速度よりも「安全で確実な認証」を最優先</p>
                    
                    <div style="margin: 30px 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                            <div style="text-align: center; margin: 10px;">
                                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                                    <strong>🔐 セキュリティ</strong><br>
                                    最高レベル<br>
                                    <small>Twitter級</small>
                                </div>
                            </div>
                            <div style="text-align: center; margin: 10px;">
                                <div style="background: #f3e5f5; padding: 15px; border-radius: 8px;">
                                    <strong>⚡ パフォーマンス</strong><br>
                                    高速<br>
                                    <small>Laravel SSR >> 現在 > 完全SPA</small>
                                </div>
                            </div>
                            <div style="text-align: center; margin: 10px;">
                                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px;">
                                    <strong>🎨 UX</strong><br>
                                    視覚的フラッシュなし<br>
                                    <small>Laravel級の堅牢性</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <p><strong>結論:</strong> Twitter/Xと同等のハイブリッドアーキテクチャで、商用SNSレベルの認証システムを実現</p>
                </div>
            </div>
        </div>
    </div>
</body>
</html>