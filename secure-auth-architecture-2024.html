<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔐 セキュアなFirebase + HttpOnly Cookie認証アーキテクチャ解説</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            border-bottom: 4px solid #e74c3c;
            padding-bottom: 15px;
            margin-bottom: 30px;
            font-size: 2.2em;
        }
        h2 {
            color: #34495e;
            border-left: 5px solid #e74c3c;
            padding-left: 20px;
            margin-top: 40px;
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 5px;
        }
        .update-notice {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
        }
        .actors {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }
        .actor {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .actor:hover {
            transform: translateY(-5px);
        }
        .actor h3 {
            margin-top: 0;
            font-size: 1.4em;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 10px;
            text-align: center;
        }
        .actor ul {
            margin: 15px 0;
            padding-left: 20px;
        }
        .actor li {
            margin: 10px 0;
            line-height: 1.5;
        }
        .security-badge {
            background: #2ecc71;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
        }
        .flow-diagram {
            background: #ecf0f1;
            padding: 25px;
            border-radius: 15px;
            margin: 25px 0;
            overflow-x: auto;
        }
        .step {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-left: 5px solid #e74c3c;
            border-radius: 10px;
            position: relative;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .step::before {
            content: attr(data-step);
            position: absolute;
            left: -20px;
            top: 20px;
            background: #e74c3c;
            color: white;
            padding: 8px 12px;
            border-radius: 50%;
            font-weight: bold;
            font-size: 14px;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin: 25px 0;
        }
        .comparison-item {
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .traditional {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .current {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        .highlight {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .security-highlight {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 15px 0;
            line-height: 1.4;
        }
        .architecture-diagram {
            text-align: center;
            margin: 40px 0;
            padding: 30px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            border: 2px solid #dee2e6;
        }
        .system-box {
            display: inline-block;
            padding: 15px 25px;
            margin: 15px;
            background: white;
            border: 3px solid #e74c3c;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .system-box:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .arrow {
            font-size: 30px;
            color: #e74c3c;
            margin: 0 15px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        .security-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        .security-feature {
            background: #2ecc71;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .security-feature h4 {
            margin-top: 0;
            font-size: 1.2em;
        }
        .tech-stack {
            background: #34495e;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        @media (max-width: 768px) {
            .comparison {
                grid-template-columns: 1fr;
            }
            .actors {
                grid-template-columns: 1fr;
            }
            .container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔐 Firebase + HttpOnly Cookie<br>セキュア認証アーキテクチャ完全解説</h1>

        <div class="update-notice">
            ✨ 2024年最新版：HttpOnly Cookie実装でセキュリティ大幅強化！ ✨
        </div>

        <div class="architecture-diagram">
            <h3>🏗️ セキュアなシステム構成図</h3>
            <div>
                <div class="system-box">🌐 ブラウザ<br>(Nuxt Client)</div>
                <span class="arrow">🔒</span>
                <div class="system-box">🚀 Nuxt サーバー<br>(HttpOnly Cookie管理)</div>
                <span class="arrow">🔒</span>
                <div class="system-box">⚡ Laravel API</div>
            </div>
            <div style="margin-top: 30px;">
                <div class="system-box">🔥 Firebase Authentication<br>(JWT発行・検証)</div>
            </div>
            <div style="margin-top: 15px; font-size: 14px; color: #666;">
                ↑ 全システムがセキュアに連携
            </div>
        </div>

        <h2>📋 4つの登場人物とその役割（最新版）</h2>
        <div class="actors">
            <div class="actor">
                <h3>🌐 ブラウザ (Nuxt Client)</h3>
                <div class="tech-stack">Vue.js + Nuxt.js + Firebase SDK</div>
                <ul>
                    <li><strong>UI提供</strong>: ログインフォーム・投稿画面の表示</li>
                    <li><strong>Firebase認証</strong>: メール・パスワードでログイン</li>
                    <li><strong>JWT取得</strong>: Firebase からIDトークンを取得</li>
                    <li><strong>セキュア送信</strong>: Nuxt APIにトークンを送信</li>
                    <li><strong>Cookie管理</strong>: HttpOnlyでJavaScriptアクセス不可 <span class="security-badge">SECURE</span></li>
                    <li><strong>API呼び出し</strong>: 全てNuxt API経由</li>
                </ul>
            </div>

            <div class="actor">
                <h3>🚀 Nuxt サーバー (認証ゲートウェイ)</h3>
                <div class="tech-stack">Node.js + Nuxt.js + Firebase Admin SDK</div>
                <ul>
                    <li><strong>認証管理</strong>: HttpOnly Cookieでトークン管理 <span class="security-badge">SECURE</span></li>
                    <li><strong>JWT検証</strong>: Firebase Admin SDKで高速検証</li>
                    <li><strong>API プロキシ</strong>: Laravel API への安全な橋渡し</li>
                    <li><strong>Cookie設定</strong>: ログイン時にセキュアCookie設定</li>
                    <li><strong>ログアウト</strong>: Cookie削除でセッション終了</li>
                    <li><strong>SSR</strong>: 初回ページの高速表示</li>
                </ul>
            </div>

            <div class="actor">
                <h3>🔥 Firebase Authentication</h3>
                <div class="tech-stack">Google Cloud Platform + Firebase</div>
                <ul>
                    <li><strong>ユーザー管理</strong>: アカウント登録・認証処理</li>
                    <li><strong>JWT発行</strong>: 署名付きIDトークン生成（1時間有効）</li>
                    <li><strong>公開鍵提供</strong>: JWT検証用の鍵情報</li>
                    <li><strong>セキュリティ</strong>: 不正アクセス検知・レート制限</li>
                    <li><strong>多要素認証</strong>: 高度なセキュリティ機能</li>
                    <li><strong>スケーラビリティ</strong>: Googleインフラで高可用性</li>
                </ul>
            </div>

            <div class="actor">
                <h3>⚡ Laravel API サーバー</h3>
                <div class="tech-stack">PHP + Laravel + MySQL</div>
                <ul>
                    <li><strong>ビジネスロジック</strong>: 投稿・コメント・いいね処理</li>
                    <li><strong>JWT検証</strong>: Firebase公開鍵でトークン検証</li>
                    <li><strong>データベース</strong>: ユーザー・投稿データ管理</li>
                    <li><strong>認可制御</strong>: 権限ベースのアクセス制御</li>
                    <li><strong>API設計</strong>: RESTful APIでデータ提供</li>
                    <li><strong>パフォーマンス</strong>: 最適化されたクエリ実行</li>
                </ul>
            </div>
        </div>

        <h2>🔄 セキュア認証フローの詳細</h2>
        
        <h3>1️⃣ ログイン時の完全セキュアフロー</h3>
        <div class="flow-diagram">
            <div class="step" data-step="1">
                <strong>🌐 ブラウザ → 🔥 Firebase Auth</strong><br>
                ユーザーがメール・パスワードを入力してFirebase SDKでログイン処理
                <div class="code-block">
// Firebase SDK でログイン
import { signInWithEmailAndPassword } from 'firebase/auth'
const userCredential = await signInWithEmailAndPassword(auth, email, password)
const idToken = await userCredential.user.getIdToken()
                </div>
            </div>
            <div class="step" data-step="2">
                <strong>🔥 Firebase Auth → 🌐 ブラウザ</strong><br>
                認証成功時、署名付きJWT IDトークンを返す（有効期限: 1時間）
            </div>
            <div class="step" data-step="3">
                <strong>🌐 ブラウザ → 🚀 Nuxt API</strong><br>
                取得したIDトークンをNuxt API（/api/auth/login）に送信
                <div class="code-block">
// セキュアなログイン処理
const response = await $fetch('/api/auth/login', {
  method: 'POST',
  body: { idToken: idToken }
})
                </div>
            </div>
            <div class="step" data-step="4">
                <strong>🚀 Nuxt サーバー → 🔥 Firebase Auth</strong><br>
                Firebase Admin SDKでIDトークンの署名・有効期限を検証
                <div class="code-block">
// サーバーサイドでの検証
const decodedToken = await admin.auth().verifyIdToken(idToken)
const uid = decodedToken.uid
                </div>
            </div>
            <div class="step" data-step="5">
                <strong>🚀 Nuxt サーバー</strong><br>
                検証成功時、HttpOnly Cookieを設定（XSS攻撃から完全保護）
                <div class="code-block">
// セキュアなCookie設定
setCookie(event, 'auth_jwt', idToken, {
  httpOnly: true,    // JavaScriptアクセス不可
  secure: true,      // HTTPS必須
  sameSite: 'lax',   // CSRF攻撃対策
  maxAge: 3600       // 1時間有効
})
                </div>
            </div>
            <div class="step" data-step="6">
                <strong>🚀 Nuxt サーバー → 🌐 ブラウザ</strong><br>
                ログイン成功レスポンスを返す（Cookieは自動で設定済み）
            </div>
        </div>

        <h3>2️⃣ API リクエスト時のセキュアプロキシフロー</h3>
        <div class="flow-diagram">
            <div class="step" data-step="1">
                <strong>🌐 ブラウザ → 🚀 Nuxt API</strong><br>
                投稿作成などのリクエスト（HttpOnly Cookieはブラウザが自動送信）
                <div class="code-block">
// クライアントは単純にNuxt APIを呼び出すだけ
const response = await $fetch('/api/posts', {
  method: 'POST',
  body: { content: '投稿内容' }
})
// Cookieは自動で送信される（HttpOnly）
                </div>
            </div>
            <div class="step" data-step="2">
                <strong>🚀 Nuxt サーバー</strong><br>
                HttpOnly CookieからJWTトークンを取得・検証
                <div class="code-block">
// サーバーサイドでCookieから認証情報取得
const authJwt = getCookie(event, 'auth_jwt')
if (!authJwt) {
  return { success: false, error: '認証が必要です' }
}
                </div>
            </div>
            <div class="step" data-step="3">
                <strong>🚀 Nuxt サーバー → ⚡ Laravel API</strong><br>
                認証済みリクエストをLaravel APIにプロキシ
                <div class="code-block">
// Laravel APIへの安全なプロキシ
const response = await $fetch('http://nginx/api/posts', {
  method: 'POST',
  headers: {
    'Cookie': `auth_jwt=${authJwt}`
  },
  body: requestBody
})
                </div>
            </div>
            <div class="step" data-step="4">
                <strong>⚡ Laravel → 🔥 Firebase Auth</strong><br>
                Laravel側でもJWTトークンを検証（二重チェック）
            </div>
            <div class="step" data-step="5">
                <strong>⚡ Laravel</strong><br>
                認証済みユーザーとして投稿をデータベースに保存
            </div>
            <div class="step" data-step="6">
                <strong>⚡ Laravel → 🚀 Nuxt → 🌐 ブラウザ</strong><br>
                処理結果をクライアントに返す
            </div>
        </div>

        <h2>🛡️ セキュリティ機能の詳細</h2>
        <div class="security-features">
            <div class="security-feature">
                <h4>🔒 HttpOnly Cookie</h4>
                <p>JavaScriptからアクセス不可でXSS攻撃を完全ブロック</p>
            </div>
            <div class="security-feature">
                <h4>🛡️ SameSite保護</h4>
                <p>CSRF攻撃を防ぐクロスサイト制限</p>
            </div>
            <div class="security-feature">
                <h4>🔐 Secure属性</h4>
                <p>HTTPS接続でのみCookie送信</p>
            </div>
            <div class="security-feature">
                <h4>⚡ JWT検証</h4>
                <p>Firebase公開鍵による署名検証</p>
            </div>
        </div>

        <h2>🆚 従来認証との比較</h2>
        <div class="comparison">
            <div class="comparison-item traditional">
                <h3>👴 従来の Laravel セッション認証</h3>
                <ul>
                    <li><strong>登場人物</strong>: Laravel + ブラウザ（2つ）</li>
                    <li><strong>認証方式</strong>: サーバーサイドセッション</li>
                    <li><strong>データ保存</strong>: サーバーのセッションストレージ</li>
                    <li><strong>識別子</strong>: セッションID（Cookie）</li>
                    <li><strong>状態管理</strong>: ステートフル</li>
                    <li><strong>スケール</strong>: サーバー台数に制限</li>
                    <li><strong>外部依存</strong>: なし</li>
                </ul>
                <div class="code-block">
// 従来のセッション認証
1. ログイン → パスワード検証
2. セッション作成 → サーバー保存
3. セッションID → Cookie送信
4. 認証 → セッションID照合
</div>
            </div>

            <div class="comparison-item current">
                <h3>🔥 Firebase + HttpOnly Cookie認証</h3>
                <ul>
                    <li><strong>登場人物</strong>: 4つのシステム連携</li>
                    <li><strong>認証方式</strong>: JWT + HttpOnly Cookie</li>
                    <li><strong>データ保存</strong>: 署名付きトークン</li>
                    <li><strong>識別子</strong>: JWT（HttpOnly Cookie）</li>
                    <li><strong>状態管理</strong>: ステートレス</li>
                    <li><strong>スケール</strong>: 無限スケール可能</li>
                    <li><strong>外部依存</strong>: Firebase（Googleインフラ）</li>
                </ul>
                <div class="code-block">
// 現在のJWT認証
1. Firebase認証 → JWT発行
2. Nuxt検証 → HttpOnly Cookie設定
3. API呼び出し → プロキシ経由
4. 二重検証 → Firebase + Laravel
</div>
            </div>
        </div>

        <div class="security-highlight">
            <h4>🎯 セキュリティ上の重要な改善点</h4>
            <ul>
                <li><strong>XSS攻撃対策</strong>: HttpOnly CookieでJavaScriptアクセス遮断</li>
                <li><strong>CSRF攻撃対策</strong>: SameSite属性で外部サイトからの攻撃をブロック</li>
                <li><strong>中間者攻撃対策</strong>: Secure属性でHTTPS必須</li>
                <li><strong>JWT改ざん検知</strong>: Firebase公開鍵による署名検証</li>
                <li><strong>二重認証</strong>: Nuxt + Laravel の両方で検証</li>
            </ul>
        </div>

        <h2>🔧 技術的な実装詳細</h2>

        <h3>🌐 ブラウザ側の役割</h3>
        <div class="highlight">
            <ul>
                <li><strong>Firebase SDK初期化</strong>: 認証プロバイダーとの接続</li>
                <li><strong>ユーザー体験</strong>: 直感的なログインUI</li>
                <li><strong>セキュア通信</strong>: 認証情報をNuxt APIに安全送信</li>
                <li><strong>状態管理</strong>: Vue.jsでリアクティブな認証状態</li>
                <li><strong>Cookie管理</strong>: ブラウザがHttpOnly Cookieを自動管理</li>
            </ul>
        </div>

        <h3>🚀 Nuxt サーバーの役割</h3>
        <div class="highlight">
            <ul>
                <li><strong>認証ゲートウェイ</strong>: 全ての認証処理の中央管理</li>
                <li><strong>Cookie管理</strong>: セキュアなHttpOnly Cookie設定・削除</li>
                <li><strong>JWT検証</strong>: Firebase Admin SDKによる高速検証</li>
                <li><strong>APIプロキシ</strong>: Laravel APIへの安全な橋渡し</li>
                <li><strong>エラーハンドリング</strong>: 認証エラーの適切な処理</li>
            </ul>
        </div>

        <h3>🔥 Firebase Authenticationの役割</h3>
        <div class="highlight">
            <ul>
                <li><strong>認証処理</strong>: 世界最高水準のセキュリティ</li>
                <li><strong>JWT発行</strong>: 改ざん不可能な署名付きトークン</li>
                <li><strong>ユーザー管理</strong>: スケーラブルなアカウント管理</li>
                <li><strong>公開鍵提供</strong>: 他システムでの検証を可能に</li>
                <li><strong>監査ログ</strong>: 認証活動の詳細記録</li>
            </ul>
        </div>

        <h3>⚡ Laravel APIの役割</h3>
        <div class="highlight">
            <ul>
                <li><strong>ビジネスロジック</strong>: アプリケーション固有の処理</li>
                <li><strong>データ永続化</strong>: MySQL での効率的なデータ管理</li>
                <li><strong>認可制御</strong>: 細かい権限管理</li>
                <li><strong>API設計</strong>: RESTful な設計パターン</li>
                <li><strong>パフォーマンス</strong>: 最適化されたクエリとキャッシュ</li>
            </ul>
        </div>

        <h2>⚡ パフォーマンス特性</h2>
        <div class="highlight">
            <h4>🚀 高速化ポイント:</h4>
            <ul>
                <li><strong>Firebase Admin SDK</strong>: JWTキャッシュで検証高速化</li>
                <li><strong>HttpOnly Cookie</strong>: 自動送信でリクエスト簡素化</li>
                <li><strong>プロキシ最適化</strong>: 最小限のオーバーヘッド（1-2ms）</li>
                <li><strong>ステートレス設計</strong>: サーバーメモリ使用量削減</li>
                <li><strong>CDN活用</strong>: 静的ファイルの高速配信</li>
            </ul>
            
            <h4>📊 レスポンス時間目安:</h4>
            <ul>
                <li><strong>ログイン処理</strong>: 200-500ms（Firebase検証含む）</li>
                <li><strong>API呼び出し</strong>: 50-100ms（プロキシ経由）</li>
                <li><strong>JWT検証</strong>: 1-5ms（キャッシュ利用時）</li>
                <li><strong>ページ表示</strong>: 100-300ms（SSR + 認証チェック）</li>
            </ul>
        </div>

        <h2>🎯 まとめ</h2>
        <div class="security-highlight">
            <h4>🏆 このアーキテクチャの優位性</h4>
            <p>
                <strong>Firebase + HttpOnly Cookie</strong> の組み合わせにより、
                <strong>セキュリティ</strong>・<strong>スケーラビリティ</strong>・<strong>保守性</strong>
                の全てを高次元で実現しています。
            </p>
            <ul>
                <li><strong>🛡️ セキュリティ</strong>: XSS・CSRF・中間者攻撃への完全対策</li>
                <li><strong>🚀 パフォーマンス</strong>: キャッシュとプロキシの最適化</li>
                <li><strong>📈 スケーラビリティ</strong>: Googleインフラの恩恵</li>
                <li><strong>🔧 保守性</strong>: 責任分離による明確な設計</li>
                <li><strong>🌐 将来性</strong>: モダンなJWT認証標準</li>
            </ul>
        </div>

        <div style="text-align: center; margin-top: 50px; padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px;">
            <h3>🎉 セキュアな認証システムの完成！</h3>
            <p style="font-size: 1.1em; margin: 15px 0;">
                <strong>4つのシステムが連携して実現する</strong><br>
                <strong>世界水準のセキュリティアーキテクチャ</strong>
            </p>
            <div style="margin-top: 20px; font-size: 0.9em; opacity: 0.9;">
                Firebase 🤝 Nuxt 🤝 Laravel 🤝 Browser = 🔐 Perfect Security
            </div>
        </div>
    </div>
</body>
</html>