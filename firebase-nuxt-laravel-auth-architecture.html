<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Authentication + Nuxt + Laravel アーキテクチャ解説</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            border-left: 4px solid #3498db;
            padding-left: 15px;
            margin-top: 30px;
        }
        .actors {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .actor {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .actor h3 {
            margin-top: 0;
            font-size: 1.3em;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 8px;
        }
        .actor ul {
            margin: 0;
            padding-left: 20px;
        }
        .actor li {
            margin: 8px 0;
        }
        .flow-diagram {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            overflow-x: auto;
        }
        .step {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #e74c3c;
            border-radius: 5px;
            position: relative;
        }
        .step::before {
            content: attr(data-step);
            position: absolute;
            left: -15px;
            top: 15px;
            background: #e74c3c;
            color: white;
            padding: 5px 10px;
            border-radius: 50%;
            font-weight: bold;
            font-size: 12px;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .comparison-item {
            padding: 20px;
            border-radius: 10px;
        }
        .traditional {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .current {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        .highlight {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .architecture-diagram {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .system-box {
            display: inline-block;
            padding: 10px 20px;
            margin: 10px;
            background: white;
            border: 2px solid #3498db;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .arrow {
            font-size: 24px;
            color: #e74c3c;
            margin: 0 10px;
        }
        @media (max-width: 768px) {
            .comparison {
                grid-template-columns: 1fr;
            }
            .actors {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔐 Firebase Authentication + Nuxt + Laravel<br>認証アーキテクチャ完全解説</h1>

        <div class="architecture-diagram">
            <h3>🏗️ システム構成図</h3>
            <div>
                <div class="system-box">🌐 ブラウザ<br>(Nuxt Client)</div>
                <span class="arrow">↔️</span>
                <div class="system-box">🚀 Nuxt サーバー<br>(SSR)</div>
                <span class="arrow">↔️</span>
                <div class="system-box">⚡ Laravel API<br>(バックエンド)</div>
            </div>
            <div style="margin-top: 20px;">
                <div class="system-box">🔥 Firebase Authentication<br>(認証プロバイダー)</div>
            </div>
            <div style="margin-top: 10px; font-size: 14px; color: #666;">
                ↑ ブラウザ・Laravel の両方と通信
            </div>
        </div>

        <h2>📋 システム構成の4つの登場人物</h2>
        <div class="actors">
            <div class="actor">
                <h3>🌐 ブラウザ (Nuxt Client)</h3>
                <ul>
                    <li><strong>役割</strong>: ユーザーインターフェース</li>
                    <li>ログインフォームの表示</li>
                    <li>Firebase SDK でログイン処理</li>
                    <li>JWTトークンをCookieに保存</li>
                    <li>APIリクエスト時にCookieを送信</li>
                    <li>SPA として動作</li>
                    <li><strong>技術</strong>: Vue.js, Nuxt.js, Firebase SDK</li>
                </ul>
            </div>

            <div class="actor">
                <h3>🚀 Nuxt サーバー (SSR)</h3>
                <ul>
                    <li><strong>役割</strong>: 中継・プロキシサーバー</li>
                    <li>Server-Side Rendering</li>
                    <li>API Routes で Laravel への橋渡し</li>
                    <li>認証チェック API の提供</li>
                    <li>Cookie の管理・転送</li>
                    <li>現在はほぼパススルー状態</li>
                    <li><strong>技術</strong>: Node.js, Nuxt.js</li>
                </ul>
            </div>

            <div class="actor">
                <h3>🔥 Firebase Authentication</h3>
                <ul>
                    <li><strong>役割</strong>: 認証プロバイダー</li>
                    <li>ユーザー登録・ログイン処理</li>
                    <li>JWT ID Token の発行</li>
                    <li>トークンの検証情報提供</li>
                    <li>パスワードリセット等</li>
                    <li>Google の管理インフラ</li>
                    <li><strong>技術</strong>: Google Cloud Platform</li>
                </ul>
            </div>

            <div class="actor">
                <h3>⚡ Laravel サーバー</h3>
                <ul>
                    <li><strong>役割</strong>: API サーバー・データ管理</li>
                    <li>投稿・コメント・いいね API</li>
                    <li>JWT トークンの検証</li>
                    <li>データベース操作</li>
                    <li>ビジネスロジック</li>
                    <li>認可 (誰が何をできるか)</li>
                    <li><strong>技術</strong>: PHP, Laravel, MySQL</li>
                </ul>
            </div>
        </div>

        <h2>🔄 認証フローの詳細</h2>
        
        <h3>1️⃣ ログイン時の流れ</h3>
        <div class="flow-diagram">
            <div class="step" data-step="1">
                <strong>ブラウザ → Firebase Auth</strong><br>
                ユーザーがメールアドレス・パスワードを入力してログインボタンをクリック
                <div class="code-block">
// Firebase SDK を使用
import { signInWithEmailAndPassword } from 'firebase/auth'
await signInWithEmailAndPassword(auth, email, password)
                </div>
            </div>
            <div class="step" data-step="2">
                <strong>Firebase Auth → ブラウザ</strong><br>
                認証成功時、JWT ID Token を返す（有効期限: 1時間）
                <div class="code-block">
// 返されるトークンの例
eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJodHRwczovL3NlY3VyZXRva2VuLmdvb2dsZS5jb20v...
                </div>
            </div>
            <div class="step" data-step="3">
                <strong>ブラウザ</strong><br>
                受け取った JWT Token を Cookie (auth_jwt) に保存
                <div class="code-block">
// Cookie に保存
const idToken = await user.getIdToken()
document.cookie = `auth_jwt=${idToken}; path=/`
                </div>
            </div>
            <div class="step" data-step="4">
                <strong>ブラウザ → Nuxt サーバー</strong><br>
                認証チェック API (/api/auth/check) を呼び出し
            </div>
            <div class="step" data-step="5">
                <strong>Nuxt サーバー → Laravel</strong><br>
                Cookie の JWT Token を Laravel の認証チェック API に転送
                <div class="code-block">
// Nuxt API Route
const response = await $fetch('http://nginx/api/auth/check', {
  headers: { 'Cookie': `auth_jwt=${authJwtCookie}` }
})
                </div>
            </div>
            <div class="step" data-step="6">
                <strong>Laravel → Firebase Auth</strong><br>
                JWT Token を Firebase に送信して検証
                <div class="code-block">
// Laravel で Firebase JWT 検証
$verifiedIdToken = $this->auth->verifyIdToken($idToken);
$uid = $verifiedIdToken->claims()->get('sub');
                </div>
            </div>
            <div class="step" data-step="7">
                <strong>Laravel → Nuxt → ブラウザ</strong><br>
                認証結果とユーザー情報を返す
            </div>
        </div>

        <h3>2️⃣ API リクエスト時の流れ（投稿作成など）</h3>
        <div class="flow-diagram">
            <div class="step" data-step="1">
                <strong>ブラウザ → Laravel API</strong><br>
                Cookie の JWT Token と共に投稿データを送信
                <div class="code-block">
POST /api/posts
Cookie: auth_jwt=eyJhbGciOiJSUzI1NiIs...
Content-Type: application/json

{ "content": "投稿内容" }
                </div>
            </div>
            <div class="step" data-step="2">
                <strong>Laravel → Firebase Auth</strong><br>
                JWT Token の有効性を検証
                <div class="code-block">
// Laravel PostController
$idToken = $request->cookie('auth_jwt');
$verifiedIdToken = $this->auth->verifyIdToken($idToken);
                </div>
            </div>
            <div class="step" data-step="3">
                <strong>Laravel</strong><br>
                Token が有効な場合、投稿をデータベースに保存
                <div class="code-block">
// ユーザー識別して投稿作成
$firebaseUid = $verifiedIdToken->claims()->get('sub');
$user = User::where('firebase_uid', $firebaseUid)->first();
$post = Post::create(['user_id' => $user->id, 'body' => $content]);
                </div>
            </div>
            <div class="step" data-step="4">
                <strong>Laravel → ブラウザ</strong><br>
                処理結果を JSON で返す
                <div class="code-block">
{
  "success": true,
  "post": { "id": 123, "body": "投稿内容", "user": {...} }
}
                </div>
            </div>
        </div>

        <h2>🆚 従来の Laravel セッション認証との比較</h2>
        <div class="comparison">
            <div class="comparison-item traditional">
                <h3>👴 従来の Laravel セッション認証</h3>
                <ul>
                    <li><strong>登場人物</strong>: Laravel サーバー + ブラウザのみ</li>
                    <li><strong>認証方法</strong>: サーバーサイドセッション</li>
                    <li><strong>データ保存</strong>: サーバーのセッションストレージ</li>
                    <li><strong>識別子</strong>: セッション ID (Cookie)</li>
                    <li><strong>検証</strong>: Laravel が全て管理</li>
                    <li><strong>状態</strong>: ステートフル</li>
                    <li><strong>スケーラビリティ</strong>: サーバー台数に制限</li>
                </ul>
                <div class="code-block">
// 従来の認証フロー
1. ログイン → Laravel でパスワード検証
2. セッション作成 → サーバーに保存
3. セッションID → Cookie で送信
4. リクエスト → セッションIDで認証
</div>
            </div>

            <div class="comparison-item current">
                <h3>🔥 現在の Firebase + JWT 認証</h3>
                <ul>
                    <li><strong>登場人物</strong>: 4つのシステムが連携</li>
                    <li><strong>認証方法</strong>: JWT Token ベース</li>
                    <li><strong>データ保存</strong>: Token 自体に情報を埋め込み</li>
                    <li><strong>識別子</strong>: JWT Token (Cookie)</li>
                    <li><strong>検証</strong>: Firebase が署名を管理</li>
                    <li><strong>状態</strong>: ステートレス</li>
                    <li><strong>スケーラビリティ</strong>: 無限にスケール可能</li>
                </ul>
                <div class="code-block">
// JWT 認証フロー
1. ログイン → Firebase で認証
2. JWT Token 発行 → 署名付き
3. Token → Cookie で保存
4. リクエスト → Token で認証
</div>
            </div>
        </div>

        <div class="highlight">
            <strong>🎯 重要なポイント</strong><br>
            従来のセッション認証では「セッション ID」は単なる識別子でしたが、JWT Token は「認証情報そのもの」を含んでいます。Firebase が署名した Token を Laravel が検証することで、Laravel は「このユーザーは確実に Firebase で認証済み」だと判断できます。
        </div>

        <h2>🔧 各システムの詳細な役割分担</h2>

        <h3>🌐 ブラウザ (Nuxt Client) の詳細</h3>
        <div class="highlight">
            <ul>
                <li><strong>Firebase SDK の初期化</strong>: アプリ起動時に Firebase 設定を読み込み</li>
                <li><strong>ログインフォーム</strong>: ユーザー入力を受け取り、バリデーション実行</li>
                <li><strong>Token 管理</strong>: JWT Token を Cookie に保存・API 呼び出し時に自動送信</li>
                <li><strong>画面表示</strong>: Vue.js コンポーネントで動的な UI をレンダリング</li>
                <li><strong>状態管理</strong>: ログイン状態、投稿データなどをリアクティブに管理</li>
                <li><strong>ルーティング</strong>: 認証が必要なページへのアクセス制御</li>
            </ul>
        </div>

        <h3>🚀 Nuxt サーバーの詳細</h3>
        <div class="highlight">
            <ul>
                <li><strong>SSR (Server-Side Rendering)</strong>: 初回ページ表示の高速化・SEO 対応</li>
                <li><strong>API Routes</strong>: <code>/api/auth/check</code> などのエンドポイント提供</li>
                <li><strong>プロキシ機能</strong>: CORS を回避して Laravel API への橋渡し</li>
                <li><strong>Cookie 処理</strong>: HttpOnly Cookie の管理（将来的な改善点）</li>
                <li><strong>開発環境</strong>: Hot Reload、TypeScript サポートなど</li>
                <li><strong>静的ファイル配信</strong>: 画像、CSS、JS の配信</li>
            </ul>
        </div>

        <h3>🔥 Firebase Authentication の詳細</h3>
        <div class="highlight">
            <ul>
                <li><strong>ユーザー管理</strong>: アカウント作成・削除・更新・パスワード管理</li>
                <li><strong>認証方式</strong>: メール/パスワード、Google、Twitter など多様な認証</li>
                <li><strong>JWT 発行</strong>: 認証成功時に署名付き Token を発行（1時間有効）</li>
                <li><strong>公開鍵提供</strong>: JWT 検証用の公開鍵を他システムに提供</li>
                <li><strong>セキュリティ</strong>: 不正アクセス検知、レート制限など</li>
                <li><strong>管理コンソール</strong>: ユーザー管理、設定変更の Web UI</li>
            </ul>
        </div>

        <h3>⚡ Laravel サーバーの詳細</h3>
        <div class="highlight">
            <ul>
                <li><strong>JWT 検証</strong>: Firebase の公開鍵で Token の署名を検証</li>
                <li><strong>ユーザー識別</strong>: JWT から Firebase UID を抽出してローカルユーザーと紐付け</li>
                <li><strong>API 設計</strong>: RESTful API でフロントエンドとデータ交換</li>
                <li><strong>データベース設計</strong>: 投稿・コメント・いいねのリレーション管理</li>
                <li><strong>認可制御</strong>: 「誰が何をできるか」の細かい権限管理</li>
                <li><strong>ビジネスロジック</strong>: いいね数の計算、投稿の並び順など</li>
            </ul>
        </div>

        <h2>🚨 現在発生している問題と解決策</h2>
        <div class="highlight">
            <h4>❌ 問題: JWT Token の有効期限切れ</h4>
            <p>Firebase の JWT Token は1時間で期限切れになり、期限切れの Token で API を呼び出すと 500 エラーが発生します。</p>
            
            <h4>🔧 解決策の選択肢:</h4>
            <ol>
                <li>
                    <strong>自動リフレッシュ (削除済み)</strong><br>
                    Firebase SDK でトークンを自動更新するが、HttpOnly Cookie でないためセキュリティリスク有り
                </li>
                <li>
                    <strong>再ログイン促進 (現在の方針)</strong><br>
                    エラー時にログイン画面にリダイレクト。シンプルで安全
                </li>
                <li>
                    <strong>サーバーサイド管理 (推奨)</strong><br>
                    Nuxt サーバーで HttpOnly Cookie + リフレッシュ Token 管理。最もセキュア
                </li>
            </ol>
        </div>

        <h2>🔐 セキュリティ考慮事項</h2>
        <div class="highlight">
            <h4>現在のセキュリティ状況:</h4>
            <ul>
                <li>✅ <strong>JWT の署名検証</strong>: Firebase の秘密鍵で署名されたトークンのみ受け入れ</li>
                <li>✅ <strong>HTTPS 通信</strong>: 本番環境では全通信を暗号化</li>
                <li>✅ <strong>CORS 設定</strong>: 許可されたドメインからのみ API アクセス可能</li>
                <li>⚠️ <strong>HttpOnly Cookie 未使用</strong>: XSS 攻撃に対して脆弱</li>
                <li>⚠️ <strong>トークン期限切れ対応</strong>: 自動更新なし</li>
            </ul>
            
            <h4>セキュリティ強化案:</h4>
            <ul>
                <li>HttpOnly Cookie でトークン管理</li>
                <li>CSP (Content Security Policy) の導入</li>
                <li>レート制限の実装</li>
                <li>ログイン試行回数の制限</li>
            </ul>
        </div>

        <h2>🎯 まとめ</h2>
        <p>
            このアーキテクチャは<strong>マイクロサービス的な構成</strong>になっており、各システムが特定の責任を持っています：
        </p>
        <ul>
            <li><strong>🔥 Firebase</strong>: 認証の専門家 → ユーザー管理・トークン発行</li>
            <li><strong>⚡ Laravel</strong>: データとビジネスロジックの専門家 → API・DB操作</li>
            <li><strong>🚀 Nuxt</strong>: フロントエンドとAPIの仲介者 → SSR・プロキシ</li>
            <li><strong>🌐 ブラウザ</strong>: ユーザーインターフェースの提供者 → UI・UX</li>
        </ul>

        <div class="highlight">
            <h4>🚀 メリット:</h4>
            <ul>
                <li><strong>スケーラビリティ</strong>: 各システムが独立してスケール可能</li>
                <li><strong>保守性</strong>: 責任分離により変更が局所化</li>
                <li><strong>専門性</strong>: 各システムが得意分野に特化</li>
                <li><strong>可用性</strong>: Firebase は Google のインフラで高可用性</li>
            </ul>
            
            <h4>⚠️ デメリット:</h4>
            <ul>
                <li><strong>複雑性</strong>: システム間の連携が複雑</li>
                <li><strong>デバッグ</strong>: 問題の原因特定が困難</li>
                <li><strong>ネットワーク</strong>: 外部サービス依存でレイテンシ増加</li>
                <li><strong>学習コスト</strong>: 複数技術の理解が必要</li>
            </ul>
        </div>

        <div style="text-align: center; margin-top: 40px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px;">
            <strong>📚 Firebase + JWT 認証は現代的で拡張性の高いアーキテクチャです</strong><br>
            <em>複雑ですが、それぞれの役割を理解すれば管理しやすくなります！</em>
        </div>
    </div>
</body>
</html>