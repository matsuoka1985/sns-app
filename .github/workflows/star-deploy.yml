name: Star-Based Deploy Control

on:
  watch:
    types: [started]  # Staræ™‚ã®ã¿

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'check'
        type: choice
        options:
        - check
        - force_start
        - force_stop
        - cleanup_all

jobs:
  deploy-control:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      issues: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Star Status
        id: check_star
        uses: actions/github-script@v7
        with:
          script: |
            const starCount = context.payload.repository?.stargazers_count || 0;
            console.log(`Current star count: ${starCount}`);
            
            let action = 'none';
            if (context.eventName === 'watch') {
              action = 'start';
            } else if (context.eventName === 'workflow_dispatch') {
              const inputAction = context.payload.inputs.action;
              if (inputAction === 'force_start') action = 'start';
              else if (inputAction === 'force_stop' || inputAction === 'cleanup_all') action = 'stop';
            }
            
            core.setOutput('action', action);
            core.setOutput('star_count', starCount);

      - name: Configure AWS credentials
        if: steps.check_star.outputs.action == 'start' || steps.check_star.outputs.action == 'stop'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::709588767777:role/sns-app-github-actions-role
          role-session-name: social-app-deploy-session
          aws-region: ap-northeast-1

      - name: Setup Terraform
        if: steps.check_star.outputs.action == 'start'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Setup Terraform Backend
        if: steps.check_star.outputs.action == 'start'
        run: |
          echo "ğŸ—ï¸ Setting up Terraform backend resources..."
          cd terraform
          terraform init
          # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒªã‚½ãƒ¼ã‚¹ã®ã¿ä½œæˆï¼ˆä¸€åº¦ã ã‘å®Ÿè¡Œã•ã‚Œã‚‹ï¼‰
          terraform apply -target=aws_s3_bucket.terraform_state \
            -target=aws_s3_bucket_versioning.terraform_state \
            -target=aws_s3_bucket_server_side_encryption_configuration.terraform_state \
            -target=aws_s3_bucket_public_access_block.terraform_state \
            -target=aws_dynamodb_table.terraform_locks \
            -auto-approve \
            -var="domain_name=${{ secrets.DOMAIN_NAME }}" \
            -var="ecr_repository_url=${{ secrets.ECR_REPOSITORY_URL }}" \
            -var="db_password=${{ secrets.DB_PASSWORD }}" \
            -var="app_key=${{ secrets.APP_KEY }}" \
            -var="firebase_credentials=${{ secrets.FIREBASE_CREDENTIALS }}" \
            -var="cors_allowed_origins=${{ secrets.CORS_ALLOWED_ORIGINS }}" \
            -var="frontend_url=${{ secrets.FRONTEND_URL }}" || echo "Backend resources already exist"

      - name: Pre-deployment Cleanup (Terraform only)
        if: steps.check_star.outputs.action == 'start'
        run: |
          echo "ğŸ§¹ Cleaning up existing resources before deployment..."
          cd terraform
          terraform destroy -auto-approve \
            -var="domain_name=${{ secrets.DOMAIN_NAME }}" \
            -var="ecr_repository_url=${{ secrets.ECR_REPOSITORY_URL }}" \
            -var="db_password=${{ secrets.DB_PASSWORD }}" \
            -var="app_key=${{ secrets.APP_KEY }}" \
            -var="firebase_credentials=${{ secrets.FIREBASE_CREDENTIALS }}" \
            -var="cors_allowed_origins=${{ secrets.CORS_ALLOWED_ORIGINS }}" \
            -var="frontend_url=${{ secrets.FRONTEND_URL }}" || echo "No existing resources to destroy"
          cd ..
          echo "âœ… Pre-deployment cleanup completed"

      - name: Setup Docker Buildx
        if: steps.check_star.outputs.action == 'start'
        uses: docker/setup-buildx-action@v3

      - name: Login to Amazon ECR
        if: steps.check_star.outputs.action == 'start'
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker images
        if: steps.check_star.outputs.action == 'start'
        run: |
          # Laravel PHPã‚¢ãƒ—ãƒªã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ—ãƒƒã‚·ãƒ¥
          docker buildx build --platform linux/amd64 --target production \
            -t ${{ secrets.ECR_REPOSITORY_URL }}:latest \
            -f docker/php/Dockerfile . --push
          
          # nginxã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ—ãƒƒã‚·ãƒ¥
          docker buildx build --platform linux/amd64 --target production \
            -t ${{ secrets.ECR_REPOSITORY_URL }}:nginx-latest \
            -f docker/nginx/Dockerfile . --push

      - name: Terraform Init
        if: steps.check_star.outputs.action == 'start'
        working-directory: ./terraform
        run: terraform init

      - name: Deploy Infrastructure (Star Added)
        if: steps.check_star.outputs.action == 'start'
        working-directory: ./terraform
        run: |
          terraform apply -auto-approve \
            -var="domain_name=${{ secrets.DOMAIN_NAME }}" \
            -var="ecr_repository_url=${{ secrets.ECR_REPOSITORY_URL }}" \
            -var="db_password=${{ secrets.DB_PASSWORD }}" \
            -var="app_key=${{ secrets.APP_KEY }}" \
            -var="firebase_credentials=${{ secrets.FIREBASE_CREDENTIALS }}" \
            -var="cors_allowed_origins=${{ secrets.CORS_ALLOWED_ORIGINS }}" \
            -var="frontend_url=${{ secrets.FRONTEND_URL }}"

      - name: Emergency Cleanup on Failure
        if: failure()
        continue-on-error: true
        run: |
          echo "ğŸš¨ DEPLOYMENT FAILED - STARTING CLEANUP ğŸš¨"
          
          # Terraform destroy
          cd terraform
          terraform destroy -auto-approve \
            -var="domain_name=${{ secrets.DOMAIN_NAME }}" \
            -var="ecr_repository_url=${{ secrets.ECR_REPOSITORY_URL }}" \
            -var="db_password=${{ secrets.DB_PASSWORD }}" \
            -var="app_key=${{ secrets.APP_KEY }}" \
            -var="firebase_credentials=${{ secrets.FIREBASE_CREDENTIALS }}" \
            -var="cors_allowed_origins=${{ secrets.CORS_ALLOWED_ORIGINS }}" \
            -var="frontend_url=${{ secrets.FRONTEND_URL }}" || true
          
          echo "âœ… Cleanup completed"

      - name: Complete Resource Cleanup (Manual or Star Removed)
        if: steps.check_star.outputs.action == 'stop'
        run: |
          echo "ğŸ§¹ STARTING COMPLETE RESOURCE CLEANUP ğŸ§¹"
          
          # Terraform destroy
          cd terraform
          terraform init || true
          terraform destroy -auto-approve \
            -var="domain_name=${{ secrets.DOMAIN_NAME }}" \
            -var="ecr_repository_url=${{ secrets.ECR_REPOSITORY_URL }}" \
            -var="db_password=${{ secrets.DB_PASSWORD }}" \
            -var="app_key=${{ secrets.APP_KEY }}" \
            -var="firebase_credentials=${{ secrets.FIREBASE_CREDENTIALS }}" \
            -var="cors_allowed_origins=${{ secrets.CORS_ALLOWED_ORIGINS }}" \
            -var="frontend_url=${{ secrets.FRONTEND_URL }}" || true
          
          echo "âœ… Complete cleanup finished"

      - name: Get Infrastructure Info
        if: steps.check_star.outputs.action == 'start'
        working-directory: ./terraform
        id: terraform
        run: |
          ALB_DNS=$(terraform output -raw alb_dns_name 2>/dev/null || echo "pending")
          API_DOMAIN=$(terraform output -raw api_domain 2>/dev/null || echo "pending") 
          echo "alb_dns=$ALB_DNS" >> $GITHUB_OUTPUT
          echo "api_domain=$API_DOMAIN" >> $GITHUB_OUTPUT

      - name: Create Issue (Deploy Started)
        if: steps.check_star.outputs.action == 'start'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ğŸš€ Social App ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹! (Staræ•°: ${{ steps.check_star.outputs.star_count }})`;
            const body = `â­ **Starã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼Social Appã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­ã§ã™**
            
            **ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±:**
            - Staræ•°: ${{ steps.check_star.outputs.star_count }}
            - API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: https://${{ steps.terraform.outputs.api_domain }}
            - ALB DNS: ${{ steps.terraform.outputs.alb_dns }}
            
            **â° ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:**
            - âœ… ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰: å®Œäº†
            - ğŸ”„ ECSã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•: é€²è¡Œä¸­ï¼ˆ5-10åˆ†ç¨‹åº¦ï¼‰
            - ğŸŒ SSLè¨¼æ˜æ›¸: è¨­å®šä¸­
            
            **ğŸ›‘ åœæ­¢æ–¹æ³•:**
            Actions â†’ Star-Based Deploy Control â†’ Run workflow â†’ cleanup_all
            
            ğŸ¤– Generated with [Claude Code](https://claude.ai/code)`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['deployment', 'auto-generated']
            });

      - name: Create Issue (Cleanup Completed)
        if: steps.check_star.outputs.action == 'stop'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ğŸ§¹ Social App ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤å®Œäº†`;
            const body = `**ğŸ›‘ å…¨ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¾ã—ãŸ**
            
            **ğŸ“Š å‰Šé™¤ã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹:**
            - ECS Cluster/Service/Task Definition
            - ALB/Target Group
            - VPC/Subnets/NAT Gateway/EIP
            - RDS Instance
            - ElastiCache Cluster
            - Route53 Records
            - ACM Certificate
            - SSM Parameters
            - CloudWatch Log Groups
            
            **ğŸ’° ã‚³ã‚¹ãƒˆå‰Šæ¸›:**
            - é«˜é¡ãƒªã‚½ãƒ¼ã‚¹ï¼ˆNAT Gatewayç­‰ï¼‰: å‰Šé™¤å®Œäº† âœ…
            - å…¨ã¦ã®ã‚¤ãƒ³ãƒ•ãƒ©ãƒªã‚½ãƒ¼ã‚¹: å‰Šé™¤å®Œäº† âœ…
            
            ğŸ¤– Generated with [Claude Code](https://claude.ai/code)`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['cleanup', 'auto-generated']
            });