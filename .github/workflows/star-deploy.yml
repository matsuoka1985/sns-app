name: Star-Based Deploy Control

on:
  watch:
    types: [started]  # Staræ™‚ã®ã¿ï¼ˆUnstarã¯æ¤œå‡ºä¸å¯ï¼‰

# ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œã§StarçŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆUnstaræ¤œå‡ºã®ãŸã‚ï¼‰
  schedule:
    - cron: '*/10 * * * *'  # 10åˆ†æ¯ã«ãƒã‚§ãƒƒã‚¯

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'check'
        type: choice
        options:
        - check
        - force_start
        - force_stop

jobs:
  deploy-control:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Star Status
        id: check_star
        uses: actions/github-script@v7
        with:
          script: |
            // ãƒªãƒã‚¸ãƒˆãƒªã®Staræ•°ã‚’å–å¾—
            const { data: repo } = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const starCount = repo.stargazers_count;
            console.log(`Current star count: ${starCount}`);
            
            // å‰å›ã®Staræ•°ã¨æ¯”è¼ƒï¼ˆGitHub Actionsã®ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ï¼‰
            const previousStarCount = process.env.PREVIOUS_STAR_COUNT || '0';
            console.log(`Previous star count: ${previousStarCount}`);
            
            let action = 'none';
            if (starCount > parseInt(previousStarCount)) {
              action = 'start';
            } else if (starCount < parseInt(previousStarCount)) {
              action = 'stop';
            }
            
            // æ‰‹å‹•å®Ÿè¡Œã®å ´åˆ
            if (context.eventName === 'workflow_dispatch') {
              action = context.payload.inputs.action === 'force_start' ? 'start' : 
                      context.payload.inputs.action === 'force_stop' ? 'stop' : 'check';
            }
            
            core.setOutput('action', action);
            core.setOutput('star_count', starCount);
            core.setOutput('previous_count', previousStarCount);

      - name: Configure AWS credentials
        if: steps.check_star.outputs.action == 'start' || steps.check_star.outputs.action == 'stop'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::709588767777:role/sns-app-github-actions-role
          role-session-name: sns-app-deploy-session
          aws-region: ap-northeast-1

      - name: Setup Terraform
        if: steps.check_star.outputs.action == 'start'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Setup Docker Buildx
        if: steps.check_star.outputs.action == 'start'
        uses: docker/setup-buildx-action@v3

      - name: Login to Amazon ECR
        if: steps.check_star.outputs.action == 'start'
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        if: steps.check_star.outputs.action == 'start'
        run: |
          docker buildx build --platform linux/amd64 --target production \
            -t ${{ secrets.ECR_REPOSITORY_URL }}:latest \
            -f docker/php/Dockerfile . --push

      - name: Terraform Init
        if: steps.check_star.outputs.action == 'start'
        working-directory: ./terraform
        run: terraform init

      - name: Deploy Infrastructure (Star Added)
        if: steps.check_star.outputs.action == 'start'
        working-directory: ./terraform
        run: |
          terraform apply -auto-approve \
            -var="domain_name=${{ secrets.DOMAIN_NAME }}" \
            -var="ecr_repository_url=${{ secrets.ECR_REPOSITORY_URL }}" \
            -var="db_password=${{ secrets.DB_PASSWORD }}" \
            -var="app_key=${{ secrets.APP_KEY }}" \
            -var="firebase_credentials=${{ secrets.FIREBASE_CREDENTIALS }}" \
            -var="cors_allowed_origins=${{ secrets.CORS_ALLOWED_ORIGINS }}" \
            -var="frontend_url=${{ secrets.FRONTEND_URL }}"

      - name: Cleanup on failure
        if: failure()
        working-directory: ./terraform
        run: |
          echo "Deployment failed, cleaning up resources..."
          terraform destroy -auto-approve \
            -var="domain_name=${{ secrets.DOMAIN_NAME }}" \
            -var="ecr_repository_url=${{ secrets.ECR_REPOSITORY_URL }}" \
            -var="db_password=${{ secrets.DB_PASSWORD }}" \
            -var="app_key=${{ secrets.APP_KEY }}" \
            -var="firebase_credentials=${{ secrets.FIREBASE_CREDENTIALS }}" \
            -var="cors_allowed_origins=${{ secrets.CORS_ALLOWED_ORIGINS }}" \
            -var="frontend_url=${{ secrets.FRONTEND_URL }}" || echo "Cleanup failed, manual intervention required"

      - name: Scale ECS Service UP
        if: steps.check_star.outputs.action == 'start'
        run: |
          aws ecs update-service \
            --cluster sns-app-cluster \
            --service sns-app-service \
            --desired-count 1

      - name: Scale ECS Service DOWN (Star Removed)
        if: steps.check_star.outputs.action == 'stop'
        run: |
          aws ecs update-service \
            --cluster sns-app-cluster \
            --service sns-app-service \
            --desired-count 0

      - name: Get Infrastructure Info
        if: steps.check_star.outputs.action == 'start'
        working-directory: ./terraform
        id: terraform
        run: |
          ALB_DNS=$(terraform output -raw alb_dns_name 2>/dev/null || echo "pending")
          API_DOMAIN=$(terraform output -raw api_domain 2>/dev/null || echo "pending") 
          echo "alb_dns=$ALB_DNS" >> $GITHUB_OUTPUT
          echo "api_domain=$API_DOMAIN" >> $GITHUB_OUTPUT

      - name: Create Issue (Cleanup Required)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `âš ï¸ ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•— - ãƒªã‚½ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ç¢ºèªè¦`;
            const body = `âŒ **ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ã¾ã—ãŸ**
            
            **è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œæ¸ˆã¿**
            ãŸã ã—ã€AWS Console ã§ä»¥ä¸‹ã‚’æ‰‹å‹•ç¢ºèªã—ã¦ãã ã•ã„ï¼š
            
            **ç¢ºèªã™ã¹ããƒªã‚½ãƒ¼ã‚¹:**
            - NAT Gateway (èª²é‡‘ç™ºç”Ÿ)
            - EIP (Elastic IP)
            - VPC
            - ECS Cluster
            - RDS Instance
            
            **æ‰‹å‹•å‰Šé™¤ãŒå¿…è¦ãªå ´åˆ:**
            AWS Console > CloudFormation ã¾ãŸã¯å„ã‚µãƒ¼ãƒ“ã‚¹ç”»é¢ã§å‰Šé™¤
            
            ---
            *ã‚³ã‚¹ãƒˆç™ºç”Ÿã‚’é˜²ããŸã‚ã€é€Ÿã‚„ã‹ã«ç¢ºèªã—ã¦ãã ã•ã„*`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['deployment-failed', 'cleanup-required', 'urgent']
            });

      - name: Create Issue (Deploy Started)
        if: steps.check_star.outputs.action == 'start'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ğŸš€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•ä¸­... (Staræ•°: ${{ steps.check_star.outputs.star_count }})`;
            const body = `â­ **Starã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­ã§ã™**
            
            **ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±:**
            - Staræ•°: ${{ steps.check_star.outputs.star_count }}
            - API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: https://${{ steps.terraform.outputs.api_domain }}
            - ALB DNS: ${{ steps.terraform.outputs.alb_dns }}
            
            **â° ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:**
            - âœ… ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰: å®Œäº†
            - ğŸ”„ ECSã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•: é€²è¡Œä¸­ï¼ˆ5-10åˆ†ç¨‹åº¦ï¼‰
            - ğŸŒ SSLè¨¼æ˜æ›¸: è¨­å®šä¸­
            
            **ğŸ›‘ åœæ­¢æ–¹æ³•:**
            ãƒªãƒã‚¸ãƒˆãƒªãƒšãƒ¼ã‚¸ã§â­Starã‚’å¤–ã—ã¦ãã ã•ã„
            
            ---
            *ã“ã® Issue ã¯10åˆ†å¾Œã«è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã™*`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['deployment', 'auto-generated']
            });

      - name: Create Issue (App Stopped)
        if: steps.check_star.outputs.action == 'stop'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `â¹ï¸ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢ (Staræ•°: ${{ steps.check_star.outputs.star_count }})`;
            const body = `**ğŸ›‘ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã—ãŸ**
            
            **ğŸ“Š ç¾åœ¨ã®çŠ¶æ³:**
            - Staræ•°: ${{ steps.check_star.outputs.star_count }}
            - ECSã‚¿ã‚¹ã‚¯æ•°: 0 (åœæ­¢çŠ¶æ…‹)
            - ã‚¤ãƒ³ãƒ•ãƒ©: ç¶­æŒä¸­
            
            **ğŸ’° ã‚³ã‚¹ãƒˆå‰Šæ¸›:**
            - ECS Fargateèª²é‡‘: åœæ­¢ âœ…
            - RDS/ElastiCache: ç¶™ç¶šä¸­ï¼ˆä½ã‚³ã‚¹ãƒˆï¼‰
            
            **ğŸš€ å†èµ·å‹•æ–¹æ³•:**
            ãƒªãƒã‚¸ãƒˆãƒªãƒšãƒ¼ã‚¸ã§â­Starã‚’ä»˜ã‘ã¦ãã ã•ã„
            
            ---
            *ã“ã® Issue ã¯10åˆ†å¾Œã«è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã™*`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['deployment', 'auto-generated']
            });

      - name: Update Star Count Record
        uses: actions/github-script@v7
        with:
          script: |
            // Staræ•°ã‚’è¨˜éŒ²ï¼ˆæ¬¡å›æ¯”è¼ƒç”¨ï¼‰
            // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€GitHub Secretsã¾ãŸã¯å¤–éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            console.log(`Recorded star count: ${{ steps.check_star.outputs.star_count }}`);
        env:
          PREVIOUS_STAR_COUNT: ${{ steps.check_star.outputs.star_count }}