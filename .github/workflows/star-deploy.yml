name: Star-Based Deploy Control

on:
  watch:
    types: [started]  # Staræ™‚ã®ã¿ï¼ˆUnstarã¯æ¤œå‡ºä¸å¯ï¼‰

# ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œã§StarçŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆUnstaræ¤œå‡ºã®ãŸã‚ï¼‰
  # schedule:
  #   - cron: '*/10 * * * *'  # 10åˆ†æ¯ã«ãƒã‚§ãƒƒã‚¯ï¼ˆã‚³ã‚¹ãƒˆå‰Šæ¸›ã®ãŸã‚ç„¡åŠ¹åŒ–ï¼‰

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'check'
        type: choice
        options:
        - check
        - force_start
        - force_stop

jobs:
  deploy-control:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      issues: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Star Status
        id: check_star
        uses: actions/github-script@v7
        with:
          script: |
            // ãƒªãƒã‚¸ãƒˆãƒªã®Staræ•°ã‚’å–å¾—
            const { data: repo } = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const starCount = repo.stargazers_count;
            console.log(`Current star count: ${starCount}`);
            
            // å‰å›ã®Staræ•°ã¨æ¯”è¼ƒï¼ˆGitHub Actionsã®ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ï¼‰
            const previousStarCount = process.env.PREVIOUS_STAR_COUNT || '0';
            console.log(`Previous star count: ${previousStarCount}`);
            
            let action = 'none';
            if (starCount > parseInt(previousStarCount)) {
              action = 'start';
            } else if (starCount < parseInt(previousStarCount)) {
              action = 'stop';
            }
            
            // æ‰‹å‹•å®Ÿè¡Œã®å ´åˆ
            if (context.eventName === 'workflow_dispatch') {
              action = context.payload.inputs.action === 'force_start' ? 'start' : 
                      context.payload.inputs.action === 'force_stop' ? 'stop' : 'check';
            }
            
            core.setOutput('action', action);
            core.setOutput('star_count', starCount);
            core.setOutput('previous_count', previousStarCount);

      - name: Configure AWS credentials
        if: steps.check_star.outputs.action == 'start' || steps.check_star.outputs.action == 'stop'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::709588767777:role/sns-app-github-actions-role
          role-session-name: sns-app-deploy-session
          aws-region: ap-northeast-1

      - name: Setup Terraform
        if: steps.check_star.outputs.action == 'start'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Setup Docker Buildx
        if: steps.check_star.outputs.action == 'start'
        uses: docker/setup-buildx-action@v3

      - name: Login to Amazon ECR
        if: steps.check_star.outputs.action == 'start'
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker images
        if: steps.check_star.outputs.action == 'start'
        run: |
          # Laravel PHPã‚¢ãƒ—ãƒªã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ—ãƒƒã‚·ãƒ¥
          docker buildx build --platform linux/amd64 --target production \
            -t ${{ secrets.ECR_REPOSITORY_URL }}:latest \
            -f docker/php/Dockerfile . --push
          
          # nginxã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ—ãƒƒã‚·ãƒ¥
          docker buildx build --platform linux/amd64 --target production \
            -t ${{ secrets.ECR_REPOSITORY_URL }}:nginx-latest \
            -f docker/nginx/Dockerfile . --push

      - name: Cleanup existing resources
        if: steps.check_star.outputs.action == 'start'
        run: |
          echo "ğŸ§¹ Comprehensive cleanup of existing resources..."
          
          # VPCé‡è¤‡é˜²æ­¢: æ—¢å­˜ã®VPCã‚’å®Œå…¨å‰Šé™¤
          echo "Deleting existing VPCs..."
          VPC_IDS=$(aws ec2 describe-vpcs --filters "Name=tag:Name,Values=sns-app-vpc" --query 'Vpcs[].VpcId' --output text)
          for vpc_id in $VPC_IDS; do
            echo "Found existing VPC: $vpc_id - Starting deletion..."
            
            # ECS Service/Clusterå‰Šé™¤ (VPCå‰Šé™¤å‰ã«å¿…è¦)
            aws ecs update-service --cluster sns-app-cluster --service sns-app-service --desired-count 0 || true
            sleep 30
            aws ecs delete-service --cluster sns-app-cluster --service sns-app-service --force || true
            aws ecs delete-cluster --cluster sns-app-cluster || true
            
            # ALBå‰Šé™¤
            ALB_ARNS=$(aws elbv2 describe-load-balancers --query "LoadBalancers[?VpcId=='$vpc_id'].LoadBalancerArn" --output text)
            for alb_arn in $ALB_ARNS; do
              echo "Deleting ALB: $alb_arn"
              aws elbv2 delete-load-balancer --load-balancer-arn $alb_arn || true
            done
            
            # Target Groupså‰Šé™¤
            TG_ARNS=$(aws elbv2 describe-target-groups --query "TargetGroups[?VpcId=='$vpc_id'].TargetGroupArn" --output text)
            for tg_arn in $TG_ARNS; do
              echo "Deleting Target Group: $tg_arn"
              aws elbv2 delete-target-group --target-group-arn $tg_arn || true
            done
            
            # RDSå‰Šé™¤ (VPCã‚µãƒ–ãƒãƒƒãƒˆä½¿ç”¨ä¸­ã®ãŸã‚)
            RDS_IDS=$(aws rds describe-db-instances --query "DBInstances[?DBSubnetGroup.VpcId=='$vpc_id'].DBInstanceIdentifier" --output text)
            for rds_id in $RDS_IDS; do
              echo "Deleting RDS: $rds_id"
              aws rds delete-db-instance --db-instance-identifier $rds_id --skip-final-snapshot --delete-automated-backups || true
            done
            
            # ElastiCacheå‰Šé™¤
            CACHE_IDS=$(aws elasticache describe-replication-groups --query 'ReplicationGroups[?contains(ReplicationGroupId,`sns-app`)].ReplicationGroupId' --output text)
            for cache_id in $CACHE_IDS; do
              echo "Deleting ElastiCache: $cache_id"
              aws elasticache delete-replication-group --replication-group-id $cache_id || true
            done
            
            # NAT Gatewayå‰Šé™¤ (EIPå‰Šé™¤å‰ã«å¿…è¦)
            NAT_IDS=$(aws ec2 describe-nat-gateways --filter "Name=vpc-id,Values=$vpc_id" --query 'NatGateways[?State==`available`].NatGatewayId' --output text)
            for nat_id in $NAT_IDS; do
              echo "Deleting NAT Gateway: $nat_id"
              aws ec2 delete-nat-gateway --nat-gateway-id $nat_id || true
            done
            
            # ENIã®å¼·åˆ¶å‰Šé™¤
            ENI_IDS=$(aws ec2 describe-network-interfaces --filters "Name=vpc-id,Values=$vpc_id" --query 'NetworkInterfaces[].NetworkInterfaceId' --output text)
            for eni_id in $ENI_IDS; do
              echo "Force detaching ENI: $eni_id"
              aws ec2 detach-network-interface --network-interface-id $eni_id --force || true
              sleep 5
              aws ec2 delete-network-interface --network-interface-id $eni_id || true
            done
            
            echo "Waiting for resource cleanup to complete..."
            sleep 120
            
            # VPCå†…ã®ã‚µãƒ–ãƒãƒƒãƒˆå‰Šé™¤
            SUBNET_IDS=$(aws ec2 describe-subnets --filters "Name=vpc-id,Values=$vpc_id" --query 'Subnets[].SubnetId' --output text)
            for subnet_id in $SUBNET_IDS; do
              echo "Deleting subnet: $subnet_id"
              aws ec2 delete-subnet --subnet-id $subnet_id || true
            done
            
            # ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤å‰Šé™¤
            IGW_IDS=$(aws ec2 describe-internet-gateways --filters "Name=attachment.vpc-id,Values=$vpc_id" --query 'InternetGateways[].InternetGatewayId' --output text)
            for igw_id in $IGW_IDS; do
              echo "Detaching and deleting IGW: $igw_id"
              aws ec2 detach-internet-gateway --internet-gateway-id $igw_id --vpc-id $vpc_id || true
              aws ec2 delete-internet-gateway --internet-gateway-id $igw_id || true
            done
            
            # ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»¥å¤–)
            RT_IDS=$(aws ec2 describe-route-tables --filters "Name=vpc-id,Values=$vpc_id" --query 'RouteTables[?Associations[0].Main != `true`].RouteTableId' --output text)
            for rt_id in $RT_IDS; do
              echo "Deleting route table: $rt_id"
              aws ec2 delete-route-table --route-table-id $rt_id || true
            done
            
            # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—å‰Šé™¤ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»¥å¤–)
            SG_IDS=$(aws ec2 describe-security-groups --filters "Name=vpc-id,Values=$vpc_id" --query 'SecurityGroups[?GroupName!=`default`].GroupId' --output text)
            for sg_id in $SG_IDS; do
              echo "Deleting security group: $sg_id"
              aws ec2 delete-security-group --group-id $sg_id || true
            done
            
            # VPCå‰Šé™¤
            echo "Finally deleting VPC: $vpc_id"
            aws ec2 delete-vpc --vpc-id $vpc_id || true
          done
          
          # EIPå‰Šé™¤ (NAT Gatewayå‰Šé™¤å¾Œ)
          sleep 60
          EIP_IDS=$(aws ec2 describe-addresses --query 'Addresses[?contains(to_string(Tags),`sns-app`)].AllocationId' --output text)
          for eip_id in $EIP_IDS; do
            echo "Releasing EIP: $eip_id"
            aws ec2 release-address --allocation-id $eip_id || true
          done
          
          # CloudWatch Logså‰Šé™¤
          aws logs delete-log-group --log-group-name /ecs/sns-app || true
          aws logs delete-log-group --log-group-name /ecs/sns-app-nginx || true
          
          # ElastiCache/RDS Subnet Groupå‰Šé™¤
          aws elasticache delete-cache-subnet-group --cache-subnet-group-name sns-app-cache-subnet || true
          aws rds delete-db-subnet-group --db-subnet-group-name sns-app-db-subnet-group || true
          
          # SSMãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å‰Šé™¤
          aws ssm delete-parameter --name /sns-app/app_key || true
          aws ssm delete-parameter --name /sns-app/db_password || true
          aws ssm delete-parameter --name /sns-app/firebase_credentials || true
          
          echo "âœ… VPC cleanup completed, waiting for AWS propagation..."
          sleep 30

      - name: Terraform Init
        if: steps.check_star.outputs.action == 'start'
        working-directory: ./terraform
        run: terraform init

      - name: Check DNS Configuration
        if: steps.check_star.outputs.action == 'start'
        run: |
          echo "ğŸ” Checking DNS configuration for SSL certificate..."
          
          # Route53ãƒãƒ¼ãƒ ã‚µãƒ¼ãƒãƒ¼ã‚’å–å¾—
          NAMESERVERS=$(aws route53 get-hosted-zone --id $(aws route53 list-hosted-zones --query "HostedZones[?Name=='${{ secrets.DOMAIN_NAME }}.'].Id" --output text | cut -d'/' -f3) --query 'DelegationSet.NameServers' --output text)
          echo "Route53 NameServers: $NAMESERVERS"
          
          # DNSä¼æ’­ç¢ºèª
          for ns in $NAMESERVERS; do
            echo "Checking DNS propagation on $ns"
            dig @$ns ${{ secrets.DOMAIN_NAME }} SOA +short || true
          done

      - name: Deploy Infrastructure (Star Added)
        if: steps.check_star.outputs.action == 'start'
        working-directory: ./terraform
        run: |
          terraform apply -auto-approve \
            -var="domain_name=${{ secrets.DOMAIN_NAME }}" \
            -var="ecr_repository_url=${{ secrets.ECR_REPOSITORY_URL }}" \
            -var="db_password=${{ secrets.DB_PASSWORD }}" \
            -var="app_key=${{ secrets.APP_KEY }}" \
            -var="firebase_credentials=${{ secrets.FIREBASE_CREDENTIALS }}" \
            -var="cors_allowed_origins=${{ secrets.CORS_ALLOWED_ORIGINS }}" \
            -var="frontend_url=${{ secrets.FRONTEND_URL }}"

      - name: Emergency Resource Cleanup on Failure
        if: failure()
        continue-on-error: true
        run: |
          echo "ğŸš¨ DEPLOYMENT FAILED - EMERGENCY CLEANUP STARTING ğŸš¨"
          
          # Terraform destroy (æœ€å„ªå…ˆ)
          cd terraform
          terraform destroy -auto-approve \
            -var="domain_name=${{ secrets.DOMAIN_NAME }}" \
            -var="ecr_repository_url=${{ secrets.ECR_REPOSITORY_URL }}" \
            -var="db_password=${{ secrets.DB_PASSWORD }}" \
            -var="app_key=${{ secrets.APP_KEY }}" \
            -var="firebase_credentials=${{ secrets.FIREBASE_CREDENTIALS }}" \
            -var="cors_allowed_origins=${{ secrets.CORS_ALLOWED_ORIGINS }}" \
            -var="frontend_url=${{ secrets.FRONTEND_URL }}" || echo "Terraform destroy failed, proceeding with manual cleanup"
          
          cd ..
          
          echo "ğŸ§¹ Manual cleanup of remaining resources..."
          
          # NAT Gatewayå‰Šé™¤ (æœ€é«˜å„ªå…ˆ - $45/æœˆ)
          NAT_IDS=$(aws ec2 describe-nat-gateways --filter "Name=tag:Name,Values=*sns-app*" --query 'NatGateways[?State==`available`].NatGatewayId' --output text)
          for nat_id in $NAT_IDS; do
            echo "Deleting NAT Gateway: $nat_id"
            aws ec2 delete-nat-gateway --nat-gateway-id $nat_id || true
          done
          
          # RDSå‰Šé™¤ (é«˜å„ªå…ˆ - $15-30/æœˆ)
          RDS_IDS=$(aws rds describe-db-instances --query 'DBInstances[?contains(DBInstanceIdentifier,`sns-app`)].DBInstanceIdentifier' --output text)
          for rds_id in $RDS_IDS; do
            echo "Deleting RDS instance: $rds_id"
            aws rds delete-db-instance --db-instance-identifier $rds_id --skip-final-snapshot --delete-automated-backups || true
          done
          
          # ElastiCacheå‰Šé™¤ (é«˜å„ªå…ˆ - $10-20/æœˆ)
          CACHE_IDS=$(aws elasticache describe-replication-groups --query 'ReplicationGroups[?contains(ReplicationGroupId,`sns-app`)].ReplicationGroupId' --output text)
          for cache_id in $CACHE_IDS; do
            echo "Deleting ElastiCache: $cache_id"
            aws elasticache delete-replication-group --replication-group-id $cache_id || true
          done
          
          # ALBå‰Šé™¤ (ä¸­å„ªå…ˆ - $20/æœˆ)
          ALB_ARNS=$(aws elbv2 describe-load-balancers --query 'LoadBalancers[?contains(LoadBalancerName,`sns-app`)].LoadBalancerArn' --output text)
          for alb_arn in $ALB_ARNS; do
            echo "Deleting ALB: $alb_arn"
            aws elbv2 delete-load-balancer --load-balancer-arn $alb_arn || true
          done
          
          # ECS Service/Clusterå‰Šé™¤
          aws ecs update-service --cluster sns-app-cluster --service sns-app-service --desired-count 0 || true
          sleep 30
          aws ecs delete-service --cluster sns-app-cluster --service sns-app-service || true
          aws ecs delete-cluster --cluster sns-app-cluster || true
          
          # EIPå‰Šé™¤ (ä½å„ªå…ˆã ãŒèª²é‡‘ã‚ã‚Š - $3.6/æœˆ)
          sleep 120  # NAT Gatewayå‰Šé™¤å¾…ã¡
          EIP_IDS=$(aws ec2 describe-addresses --query 'Addresses[?contains(to_string(Tags),`sns-app`)].AllocationId' --output text)
          for eip_id in $EIP_IDS; do
            echo "Releasing EIP: $eip_id"
            aws ec2 release-address --allocation-id $eip_id || true
          done
          
          # Target Groupså‰Šé™¤
          TG_ARNS=$(aws elbv2 describe-target-groups --query 'TargetGroups[?contains(TargetGroupName,`sns-app`)].TargetGroupArn' --output text)
          for tg_arn in $TG_ARNS; do
            echo "Deleting Target Group: $tg_arn"
            aws elbv2 delete-target-group --target-group-arn $tg_arn || true
          done
          
          # VPCå‰Šé™¤ (ä¸Šé™ã‚¨ãƒ©ãƒ¼å¯¾ç­–)
          VPC_IDS=$(aws ec2 describe-vpcs --query 'Vpcs[?Tags[?Key==`Name` && contains(Value,`sns-app`)]].VpcId' --output text)
          for vpc_id in $VPC_IDS; do
            echo "Deleting VPC dependencies for: $vpc_id"
            
            # VPCå†…ã®ã‚µãƒ–ãƒãƒƒãƒˆå‰Šé™¤
            SUBNET_IDS=$(aws ec2 describe-subnets --filters "Name=vpc-id,Values=$vpc_id" --query 'Subnets[].SubnetId' --output text)
            for subnet_id in $SUBNET_IDS; do
              aws ec2 delete-subnet --subnet-id $subnet_id || true
            done
            
            # ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤å‰Šé™¤
            IGW_IDS=$(aws ec2 describe-internet-gateways --filters "Name=attachment.vpc-id,Values=$vpc_id" --query 'InternetGateways[].InternetGatewayId' --output text)
            for igw_id in $IGW_IDS; do
              aws ec2 detach-internet-gateway --internet-gateway-id $igw_id --vpc-id $vpc_id || true
              aws ec2 delete-internet-gateway --internet-gateway-id $igw_id || true
            done
            
            # ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»¥å¤–)
            RT_IDS=$(aws ec2 describe-route-tables --filters "Name=vpc-id,Values=$vpc_id" --query 'RouteTables[?Associations==`null`].RouteTableId' --output text)
            for rt_id in $RT_IDS; do
              aws ec2 delete-route-table --route-table-id $rt_id || true
            done
            
            # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—å‰Šé™¤ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»¥å¤–)
            SG_IDS=$(aws ec2 describe-security-groups --filters "Name=vpc-id,Values=$vpc_id" --query 'SecurityGroups[?GroupName!=`default`].GroupId' --output text)
            for sg_id in $SG_IDS; do
              aws ec2 delete-security-group --group-id $sg_id || true
            done
            
            # VPCå‰Šé™¤
            echo "Deleting VPC: $vpc_id"
            aws ec2 delete-vpc --vpc-id $vpc_id || true
          done
          
          echo "âœ… Emergency cleanup completed - major cost resources and VPCs deleted"

      - name: Scale ECS Service UP
        if: steps.check_star.outputs.action == 'start'
        run: |
          aws ecs update-service \
            --cluster sns-app-cluster \
            --service sns-app-service \
            --desired-count 1

      - name: Scale ECS Service DOWN (Star Removed)
        if: steps.check_star.outputs.action == 'stop'
        run: |
          aws ecs update-service \
            --cluster sns-app-cluster \
            --service sns-app-service \
            --desired-count 0

      - name: Get Infrastructure Info
        if: steps.check_star.outputs.action == 'start'
        working-directory: ./terraform
        id: terraform
        run: |
          ALB_DNS=$(terraform output -raw alb_dns_name 2>/dev/null || echo "pending")
          API_DOMAIN=$(terraform output -raw api_domain 2>/dev/null || echo "pending") 
          echo "alb_dns=$ALB_DNS" >> $GITHUB_OUTPUT
          echo "api_domain=$API_DOMAIN" >> $GITHUB_OUTPUT

      - name: Create Issue (Cleanup Required)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `âš ï¸ ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•— - ãƒªã‚½ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ç¢ºèªè¦`;
            const body = `âŒ **ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ã¾ã—ãŸ**
            
            **è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œæ¸ˆã¿**
            ãŸã ã—ã€AWS Console ã§ä»¥ä¸‹ã‚’æ‰‹å‹•ç¢ºèªã—ã¦ãã ã•ã„ï¼š
            
            **ç¢ºèªã™ã¹ããƒªã‚½ãƒ¼ã‚¹:**
            - NAT Gateway (èª²é‡‘ç™ºç”Ÿ)
            - EIP (Elastic IP)
            - VPC
            - ECS Cluster
            - RDS Instance
            
            **æ‰‹å‹•å‰Šé™¤ãŒå¿…è¦ãªå ´åˆ:**
            AWS Console > CloudFormation ã¾ãŸã¯å„ã‚µãƒ¼ãƒ“ã‚¹ç”»é¢ã§å‰Šé™¤
            
            ---
            *ã‚³ã‚¹ãƒˆç™ºç”Ÿã‚’é˜²ããŸã‚ã€é€Ÿã‚„ã‹ã«ç¢ºèªã—ã¦ãã ã•ã„*`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['deployment-failed', 'cleanup-required', 'urgent']
            });

      - name: Create Issue (Deploy Started)
        if: steps.check_star.outputs.action == 'start'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ğŸš€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•ä¸­... (Staræ•°: ${{ steps.check_star.outputs.star_count }})`;
            const body = `â­ **Starã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­ã§ã™**
            
            **ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±:**
            - Staræ•°: ${{ steps.check_star.outputs.star_count }}
            - API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: https://${{ steps.terraform.outputs.api_domain }}
            - ALB DNS: ${{ steps.terraform.outputs.alb_dns }}
            
            **â° ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:**
            - âœ… ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰: å®Œäº†
            - ğŸ”„ ECSã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•: é€²è¡Œä¸­ï¼ˆ5-10åˆ†ç¨‹åº¦ï¼‰
            - ğŸŒ SSLè¨¼æ˜æ›¸: è¨­å®šä¸­
            
            **ğŸ›‘ åœæ­¢æ–¹æ³•:**
            ãƒªãƒã‚¸ãƒˆãƒªãƒšãƒ¼ã‚¸ã§â­Starã‚’å¤–ã—ã¦ãã ã•ã„
            
            ---
            *ã“ã® Issue ã¯10åˆ†å¾Œã«è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã™*`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['deployment', 'auto-generated']
            });

      - name: Create Issue (App Stopped)
        if: steps.check_star.outputs.action == 'stop'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `â¹ï¸ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢ (Staræ•°: ${{ steps.check_star.outputs.star_count }})`;
            const body = `**ğŸ›‘ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã—ãŸ**
            
            **ğŸ“Š ç¾åœ¨ã®çŠ¶æ³:**
            - Staræ•°: ${{ steps.check_star.outputs.star_count }}
            - ECSã‚¿ã‚¹ã‚¯æ•°: 0 (åœæ­¢çŠ¶æ…‹)
            - ã‚¤ãƒ³ãƒ•ãƒ©: ç¶­æŒä¸­
            
            **ğŸ’° ã‚³ã‚¹ãƒˆå‰Šæ¸›:**
            - ECS Fargateèª²é‡‘: åœæ­¢ âœ…
            - RDS/ElastiCache: ç¶™ç¶šä¸­ï¼ˆä½ã‚³ã‚¹ãƒˆï¼‰
            
            **ğŸš€ å†èµ·å‹•æ–¹æ³•:**
            ãƒªãƒã‚¸ãƒˆãƒªãƒšãƒ¼ã‚¸ã§â­Starã‚’ä»˜ã‘ã¦ãã ã•ã„
            
            ---
            *ã“ã® Issue ã¯10åˆ†å¾Œã«è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã™*`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['deployment', 'auto-generated']
            });

      - name: Update Star Count Record
        uses: actions/github-script@v7
        with:
          script: |
            // Staræ•°ã‚’è¨˜éŒ²ï¼ˆæ¬¡å›æ¯”è¼ƒç”¨ï¼‰
            // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€GitHub Secretsã¾ãŸã¯å¤–éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            console.log(`Recorded star count: ${{ steps.check_star.outputs.star_count }}`);
        env:
          PREVIOUS_STAR_COUNT: ${{ steps.check_star.outputs.star_count }}