name: Deploy Infrastructure

on:
  push:
    paths:
      - 'terraform/**'
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-1

jobs:
  deploy-bootstrap:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::709588767777:role/sns-app-github-actions-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.7

      - name: Deploy S3 Backend (Bootstrap)
        id: bootstrap
        working-directory: terraform/bootstrap
        run: |
          echo "🚀 Creating S3 backend..."
          terraform init
          terraform plan -out=bootstrap.tfplan
          terraform apply bootstrap.tfplan
          
          # Get bucket name for next step
          BUCKET_NAME=$(terraform output -raw s3_bucket_name)
          echo "bucket_name=$BUCKET_NAME" >> $GITHUB_OUTPUT

  deploy-infrastructure:
    needs: deploy-bootstrap
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::709588767777:role/sns-app-github-actions-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.7

      - name: Update Backend Configuration
        working-directory: terraform
        run: |
          echo "🔧 Updating backend configuration with actual bucket name..."
          BUCKET_NAME="${{ needs.deploy-bootstrap.outputs.bucket_name }}"
          sed -i "s/sns-app-terraform-state/$BUCKET_NAME/g" main.tf

      - name: Deploy Main Infrastructure
        working-directory: terraform
        run: |
          echo "🏗️ Deploying main infrastructure..."
          terraform init
          terraform plan \
            -var="domain_name=${{ secrets.DOMAIN_NAME }}" \
            -var="app_key=${{ secrets.APP_KEY }}" \
            -var="db_username=${{ secrets.DB_USERNAME }}" \
            -var="db_password=${{ secrets.DB_PASSWORD }}" \
            -out=tfplan
          terraform apply tfplan

      - name: Output Infrastructure Info
        working-directory: terraform
        run: |
          echo "✅ Infrastructure deployed successfully!"
          echo "🌐 ALB DNS: $(terraform output -raw alb_dns_name)"
          echo "🔗 Domain: https://$(terraform output -raw domain_name)"
          echo "📦 ECS Cluster: $(terraform output -raw ecs_cluster_name)"